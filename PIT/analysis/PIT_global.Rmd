---
title: "PIT_global"
author: "C Newton"
date: "3/26/2021"
output: pdf_document
---
## Record of analysis of PIT data

### KEY INFO
* 12 Trials repeated in 3 blocks, with different return con/env type      
* <Trial><Info> = 3 levels: NoChange (1) NoOpticFlow (2) NoDistalCue (3)  
* <EnvironmentNumber> = 3 levels: 0 / 1 / 2                                
* <ReachedOutOfBounds> = logical TRUE (1) / FALSE (0)                     


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# load environment
require(ggplot2)
library(tidyverse)
require(readxl)
require(RColorBrewer)
require(ggthemes)
require(ggsignif)
require(lme4)
require(knitr)
# make custom colour palettes
myOrange = brewer.pal(n=9,"Oranges")[3:6]
```

### Load in global PIT csv file + PREVENT demographics
```{r}
PITall <- read_csv('/lustre/scratch/wbic-beta/ccn30/ENCRYPT/results/PIT/Global_Results/PITall.csv')
PITall <- PITall %>% mutate(across(c(1:6,21:23),as_factor))

PREVENTmeta.35_in = read_csv('/lustre/scratch/wbic-beta/ccn30/ENCRYPT/PREVENT/PREVENTdata_ENCRYPTn35.csv')
APOEin <- read_excel('/lustre/scratch/wbic-beta/ccn30/ENCRYPT/PREVENT/APOE_Baseline_CB.xlsx')

## TIDY
PREVENTmeta.35 <- left_join(PREVENTmeta.35_in,APOEin)
# make new variables
PREVENTmeta.35 <- PREVENTmeta.35 %>% mutate(FH = case_when(risk_demf == 1 ~ 1,risk_demm == 1 ~ 1, risk_demf == 0 ~ 0, risk_demm == 0 ~ 0))
PREVENTmeta.35 <- PREVENTmeta.35 %>% mutate(across(c(1,3,56,568,572,707,708,709),as_factor))

## COMBINE
PITall.PREVENTmeta <- left_join(PITall,PREVENTmeta.35,by = c("Code"="subjectID"))

# some summary stats
MeanRoterror <- mean(PITall$AAerror)
MeanADerror <- mean(PITall$ADerror)
table(PITall$Block,PITall$Env) # check randomisation of environment order
```

```{r}
# summary table
table.summary <- PITall %>% 
  group_by(Code,Env,Type) %>% 
  summarize(ADerrorMEAN = mean(ADerror),ADerrorSE = sd(ADerror)/sqrt(n()), n_samples = n())
head(table.summary)
```

## Absolute distance error
```{r}
# plot ADerror by environment type and trial type
pd <- position_dodge2(0.4)
ggplot(data=PITall,aes(x=Type,y=ADerror,colour=Type)) +
  facet_grid(~Env) +
  geom_boxplot(outlier.shape = NA,show.legend=FALSE) +
  geom_point(aes(colour=Type),position=pd,alpha=0.8,show.legend=FALSE) +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Absolute distance error by environment and trial type',x='Trial type',y='Euclidean distance error')
```

### AD error across trial type
```{r}
# with boxplot
pd <- position_dodge2(0.3)
ggplot(data=PITall,aes(x=Type,y=ADerror,colour=Type)) +
  geom_boxplot(outlier.shape = NA,show.legend=FALSE,width=0.8) +
  geom_jitter(aes(colour=Type),width=0.2,alpha=0.8,show.legend=FALSE) +
  scale_colour_manual(values = c("#008000", "#008B8B", "#66CDAA")) +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Euclidean distance error by trial type',x='Trial type',y='Euclidean distance error') +
  geom_signif(comparisons=list(c("1","3")),map_signif_level=TRUE,colour='black')
```

### AD error by environment type
```{r}
ggplot(data=PITall,aes(x=Env,y=ADerror,colour=Env)) +
  geom_boxplot(outlier.shape = NA,show.legend=FALSE,width=0.8) +
  geom_jitter(aes(colour=Env),width=0.2,alpha=0.8,show.legend=FALSE) +
  scale_colour_manual(values = c("#FF6600", "#CCCC00", "#99CC00")) +
  scale_x_discrete(labels = c("One","Two", "Three")) +
  labs(title='Euclidean distance error by environment type',x='Enviornment type',y='Euclidean distance error') 
 # geom_signif(comparisons=list(c("3","2")),map_signif_level=TRUE,colour='black')
```


### without out of bounds trials
```{r}
# split by OoB
ggplot(data=PITall,aes(x=Type,y=ADerror,colour=OoB)) +
  geom_boxplot() +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Distance error differences for out of bounds trials',x='Trial type',y='Euclidean distance error',colour="Out of Bounds")
```

```{r}
PITall.noOoB <- PITall %>% filter(OoB == 0)
ggplot(data=PITall.noOoB,aes(x=Type,y=ADerror,colour=Type)) +
  geom_boxplot(outlier.shape = NA,show.legend=FALSE,width=0.8) +
  geom_jitter(aes(colour=Type),width=0.2,alpha=0.8,show.legend=FALSE) +
  scale_colour_manual(values = c("#008000", "#008B8B", "#66CDAA")) +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Euclidean distance error by trial type, OoB trials excluded',x='Trial type',y='Euclidean distance error') +
  geom_signif(comparisons=list(c("1","3")),map_signif_level=TRUE,colour='black')
```

## Absolute distance error associations with demographics and AD Risk

### Family history
```{r}
# summary table
table.summary.demo <- PITall.PREVENTmeta %>% 
  group_by(FH,Type) %>% 
  summarize(ADerrorMEAN = mean(ADerror),ADerrorSE = sd(ADerror)/sqrt(n()), n_samples = n())
head(table.summary.demo)
```


```{r}
ggplot(data=PITall.PREVENTmeta,aes(x=Type,y=ADerror,colour=FH)) +
  geom_boxplot() +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  scale_colour_manual(values=myOrange) +
  labs(title='Distance error family history group differences',x='Trial type',y='Euclidean distance error',colour="Family History (M + P)")
```

```{r}
PITall.PREVENTmeta %>% filter(OoB == 0) %>%
ggplot(aes(x=Type,y=ADerror,colour=FH)) +
  geom_boxplot() +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Distance error family history group differences, OoB excluded',x='Trial type',y='Euclidean distance error',colour="Family History (M + P)")
```
```{r}
table(PITall.PREVENTmeta$OoB, PITall.PREVENTmeta$FH)
```


### APOE
```{r}
# summary table
table.summary.demo2 <- PITall.PREVENTmeta %>% 
  group_by(apoe4,Type) %>% 
  summarize(ADerrorMEAN = mean(ADerror),ADerrorSE = sd(ADerror)/sqrt(n()), n_samples = n())
head(table.summary.demo2)
```

## Angular error
```{r}
# plot roational error by environment type and trial type
pd <- position_dodge2(0.4)
ggplot(data=PITall,aes(x=Type,y=PAerror,colour=Type)) +
  facet_grid(~Env) +
  geom_boxplot(outlier.shape = NA,show.legend=FALSE) +
  geom_point(aes(colour=Type),position=pd,alpha=0.8,show.legend=FALSE) +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  ylim(0,3) +
  labs(title='Relative rotation error by environment and trial type',x='Trial type',y='Relative rotation error')
```


## Statistics
```{r}
# distance error all trials
PIT_ADerr_aov <- aov(data=PITall, ADerror ~ Env * Type)
summary(PIT_ADerr_aov) # there is a main effect of type
PIT_ADerr_tukey <- TukeyHSD(PIT_ADerr_aov) # significant difference 3vs1
PIT_ADerr_tukey
```

```{r}
# distance error excluding OoB trials
PIT.noOoB_ADerr_aov <- aov(data=PITall.noOoB, ADerror ~ Env * Type)
summary(PIT.noOoB_ADerr_aov) # there is a main effect of type
PIT.noOoB_ADerr_tukey <- TukeyHSD(PIT.noOoB_ADerr_aov) # significant difference 3vs1
PIT.noOoB_ADerr_tukey
```

```{r}
#angular error
PIT_AAerr_aov <- aov(data=PITall,AAerror ~ Env * Type)
summary(PIT_AAerr_aov)
PIT_AAerr_tukey <- TukeyHSD(PIT_AAerr_aov)
```

############################################################################
## additional code/plots

```{r}
# with violin
ggplot(data=PITall,aes(x=Type,y=ADerror,colour=Type)) +
  geom_violin(show.legend=FALSE) +
  geom_jitter(height=0,width=0.3,show.legend = FALSE) +
  geom_boxplot(width=0.1, colour="black", outlier.shape = NA, alpha = 0.6) +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Euclidean distance error by trial type',x='Trial type',y='Euclidean distance error') +
  scale_colour_manual(values = c("#008000", "#008B8B", "#66CDAA")) +
  geom_signif(comparisons=list(c("1","3")),map_signif_level=TRUE,colour='black')
```

```{r}
# split by OoB
ggplot(data=PITall,aes(x=Type,y=ADerror,colour=OoB)) +
  geom_boxplot() +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Distance error by trial type',x='Trial type',y='Euclidean distance error',colour="Out of Bounds")
```

# Plot AA error across trial type
```{r}
# with boxplot
pd <- position_dodge2(0.3)
ggplot(data=PITall,aes(x=Type,y=AAerror,colour=Type)) +
  geom_boxplot(outlier.shape = NA,show.legend=FALSE,width=0.8) +
  geom_jitter(aes(colour=Type),width=0.2,alpha=0.8,show.legend=FALSE) +
  scale_colour_manual(values = c("#008000", "#008B8B", "#66CDAA")) +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Angular error by trial type',x='Trial type',y='Angular error') +
  geom_signif(comparisons=list(c("1","3")),map_signif_level=TRUE,colour='black')
```

```{r}
# split by under or over rotation
ggplot(data=PITall,aes(x=Type,y=AAerror,colour=PAng)) +
  geom_boxplot() +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  labs(title='Angular error by trial type',x='Trial type',y='Angular error',colour="Type of rotation error")
```

###############################################################
# Plot spatial maps of data
  
  
```{r}
ggplot(PITall,aes(Flag1_1, Flag1_2)) + 
  geom_point(size=6,colour='green') +
  geom_point(aes(Trig_1,Trig_2,colour=Mean_AD_error),alpha=0.9) +
  scale_colour_manual(values=c("#FFEAA5", "#38808F"),
                      name="Distance error",
                      labels=c("Below average","Above average")) +
  xlim(-3,3) + ylim(-3,3) +
  labs(title='Estimated locations of Cone 1',x='',y='') +
  theme(plot.background = element_rect(fill = "#191970"),
        panel.background = element_rect(fill = "#191970"),
        panel.grid.minor = element_blank(),
        panel.grid.major= element_blank(),
        axis.text = element_text(colour="white"),
        plot.title = element_text(colour="white",face="bold"),
        legend.background = element_rect(fill = "#191970"),
        legend.title = element_text(colour="white"),
        legend.text = element_text(colour="white")
        )
```

```{r}
# plot triggered positions just for one cone 1 location
PITall.c1ex <- PITall %>% filter(Flag1_1 > 1.5 & Flag1_2 > 1.5)
PITall.c1c3.ex <- PITall.c1ex %>% filter(Flag3_1 < 0 & Flag3_2 > 0)

ggplot(PITall.c1c3.ex,aes(Flag1_1, Flag1_2)) + 
  geom_point(size=6,colour='green') +
#  geom_point(aes(Flag3_1,Flag3_2)) +
  geom_point(aes(Trig_1,Trig_2,colour=Mean_AD_error),alpha=0.9) +
  scale_colour_manual(values=c("#FFEAA5", "#38808F"),
                      name="Distance error",
                      labels=c("Below average","Above average")) +
  xlim(-2.5,2.5) + ylim(-2.5,2.5) +
  labs(title='Estimated locations of Cone 1',x='',y='') +
  theme(plot.background = element_rect(fill = "#191970"),
        panel.background = element_rect(fill = "#191970",colour="white"),
        panel.grid.minor = element_blank(),
        panel.grid.major= element_blank(),
        axis.text = element_text(colour="white"),
#        axis.line = element_line(colour="white"),
        plot.title = element_text(colour="white",face="bold"),
        legend.background = element_rect(fill = "#191970"),
        legend.title = element_text(colour="white"),
        legend.text = element_text(colour="white")
  )
```

# plot above with lines

```{r}
ggplot(PITall.c1c3.ex,aes(Flag1_1, Flag1_2)) + 
  geom_point(size=6,colour='white') +
#  geom_point(aes(Flag2_1,Flag2_2),colour='white') +
#   geom_label(label="Cone 1", x=2.4,y=2,label.padding=unit(0.1,"lines")) +
#  geom_point(aes(x=0,y=-2),colour='white') +
  geom_point(aes(Flag3_1,Flag3_2),colour='white') +
  geom_point(aes(Trig_1,Trig_2),alpha=0.9,colour="#38808F",show.legend = FALSE) +
  geom_segment(aes(x=Flag3_1,y=Flag3_2,xend=Trig_1,yend=Trig_2),colour="#38808F",alpha=0.3,show.legend = FALSE) +
#  geom_segment(aes(x=Flag1_1,y=Flag1_2,xend=0,yend=-2),colour='white') +
#  facet_grid(~Mean_AD_error) +
  xlim(-2.5,2.5) + ylim(-2.5,2.5) +
  labs(title='Estimated locations of Cone 1 from Cone 3',x='',y='') +
  theme(plot.background = element_rect(fill = "#191970"),
        panel.background = element_rect(fill = "#191970"), #,colour="white"),
        panel.grid.minor = element_blank(),
        panel.grid.major= element_blank(),
        axis.text = element_text(colour="white"),
        #        axis.line = element_line(colour="white"),
        plot.title = element_text(colour="white",face="bold"),
        legend.background = element_rect(fill = "#191970"),
        legend.title = element_text(colour="white"),
        legend.text = element_text(colour="white"),
        strip.background = element_rect(colour='white',fill='white')
  )
```

```{r}
# plot example triangle
PITex <- PITall.c1c3.ex[1,]
ggplot(PITex) +
  geom_point(aes(Flag1_1,Flag1_2), size=6, colour="green") +
  geom_point(aes(Flag3_1,Flag3_2),colour='white') +
  xlim(-2.5,2.5) + ylim(-2.5,2.5) +
  geom_point(aes(Flag2_1,Flag2_2),colour='white') +
  geom_point(aes(Trig_1,Trig_2),alpha=0.9) +
  geom_segment(aes(x=Flag3_1,y=Flag3_2,xend=Trig_1,yend=Trig_2),alpha=0.3,show.legend = FALSE) +
  geom_segment(aes(Flag1_1,Flag1_2,xend=Flag2_1,yend=Flag2_2),colour='white') +
  geom_segment(aes(Flag3_1,Flag3_2,xend=Flag2_1,yend=Flag2_2),colour='white') +
  labs(title='Estimated locations of Cone 1',x='',y='') +
  theme(plot.background = element_rect(fill = "#191970"),
        panel.background = element_rect(fill = "#191970",colour="white"),
        panel.grid.minor = element_blank(),
        panel.grid.major= element_blank(),
        axis.text = element_text(colour="white"),
        #        axis.line = element_line(colour="white"),
        plot.title = element_text(colour="white",face="bold"),
        legend.background = element_rect(fill = "#191970"),
        legend.title = element_text(colour="white"),
        legend.text = element_text(colour="white"),
        strip.background = element_rect(colour='white',fill='white')
  )
```
