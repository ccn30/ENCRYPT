---
title: "ENCRYPT_Science_code"
author: "C Newton"
date: "2022-11-15"
output: pdf_document
---

KEY INFO
* 12 Trials repeated in 3 blocks, with different return condition/environment type      
* Risk stratification either  
    - Family history (FH)  
    - APOE-e4 status (apoe4)  
    - CAIDE score, continuous (DRS_noAP) or binary below/above median (CAIDELabs_noAPOE)  
* When examining PIT, either used performance per trial/condition (PITall data sets) or mean performance per condition (PITtypemean data sets) or change in mean performance across conditions (PITchange data sets)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# load environment
library(ggplot2)
library(tidyverse)
library(data.table)
library(readxl)
library(RColorBrewer)
library(ggthemes)
library(ggsignif)
library(lme4)
library(lmerTest)
library(emmeans)
library(knitr)
library(ggpubr)
library(rstatix)
library(colorspace)
library(readr)
library(interactions)
```



# Variables
```{r,include=FALSE}
## PIT
PITall <- read_csv('/Users/ccnewton/Local\ Documents/ENCRYPT_data/PIT/PITall_n100.csv')
# round numbers
PITall <- PITall %>% mutate(across(where(is.numeric), ~ round(., 2)))
# make new variables
PITall[,24:26] <- round(PITall[,24:26],1)
PITall[,34] <- round(PITall[,34],0)
PITall$AngleIncomBin <- cut_interval(PITall$AngleIncomAbs,length = 5)
PITall <- PITall %>% mutate(DistIncomCat = as_factor(DistIncom), DistOutCat = as_factor(DistOut),AngleIncomAbsCat = as_factor(AngleIncomAbs))
PITall <- PITall %>% mutate(across(c(1:6,29,30,31,33),as_factor))

# separate outcomes with and without missing subjects
PITall.full <- PITall
PITall <- PITall %>% filter(Code != "CB045")

## PREVENT - load in file from PREVENTmetadata_2_ENCRYPT.R
PREVENTmeta = read_csv('/Users/ccnewton/Local\ Documents/ENCRYPT_data/PREVENT/PREVENTdata_ENCRYPTn100.csv')
PREVENTmeta <- PREVENTmeta %>% mutate(across(c(1,2,3,8,9,563,564,567,568,677,708,712,757:763),as_factor))
PREVENTmeta.full <- PREVENTmeta
PREVENTmeta <- PREVENTmeta %>% filter(subjectID != "CB045")
PREVENTmeta.clean <- filter(PREVENTmeta, !is.na(apoe4))

# make custom colour palettes
myOrange = brewer.pal(n=9,"Oranges")[3:6]
myBlue = brewer.pal(n=9,"Blues")[3:6]
options(digits=3)
options(scipen = 999) 
# custom functions
standard_error <- function(x) sd(x) / sqrt(length(x))

## COMBINE
PITall.PREVENTmeta <- left_join(PITall,PREVENTmeta,by = c("Code"="subjectID"))
PITall.PREVENTmeta.full <- left_join(PITall.full,PREVENTmeta.full,by = c("Code"="subjectID"))
PITall.PREVENTmeta.clean <- PITall.PREVENTmeta %>% filter(!is.na(apoe4))

## REMOVE OUT OF BOUNDS TRIALS
PITall.PREVENTmeta.noOoB <- PITall.PREVENTmeta %>% filter(OoB == 0)
PITall.PREVENTmeta.noOoB.full <- PITall.PREVENTmeta.full %>% filter(OoB == 0)
PITall.noOoB <- PITall %>% filter(OoB==0)
PITall.PREVENTmeta.clean.noOoB <- PITall.PREVENTmeta %>% filter(OoB == 0) %>% filter(!is.na(apoe4))
PITall.MRI.clean.noOoB <- PITall.PREVENTmeta.clean.noOoB %>% filter(MRI=="y")

## SUMMARY VARIABLES
# average per condition or block
PITglobalmean <- filter(PITall.full,OoB == 0) %>% 
  group_by(Code) %>%
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITblockmean <- filter(PITall,OoB == 0) %>% 
  group_by(Code, Block) %>% 
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITtypemean <- filter(PITall,OoB == 0,Code!="WL208") %>% 
  group_by(Code, Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITtypemean2 <- filter(PITall.full,OoB == 0) %>% 
  group_by(Code, Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITdistmean <- filter(PITall,OoB == 0) %>% 
  group_by(Code, DistIncomCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITdistmean$DistIncom <- as.numeric(as.character(PITdistmean$DistIncomCat))
PITanglemean <- filter(PITall,OoB == 0) %>% 
  group_by(Code, AngleIncomAbsCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITanglemean$AngleIncom <- as.numeric(as.character(PITanglemean$AngleIncomAbsCat))
# as above with  OOB
PITglobalmeanOOB <- PITall.full %>% group_by(Code) %>%
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITblockmeanOOB <-  PITall %>% group_by(Code, Block) %>% 
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITtypemeanOOB <-  PITall %>% group_by(Code, Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITdistmeanOOB <-  PITall %>% group_by(Code, DistIncomCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITanglemeanOOB <-  PITall %>% group_by(Code, AngleIncomAbsCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))

# Combine summaries
PITglobalmean.PREVENTmeta <- left_join(PITglobalmean,PREVENTmeta.full,by = c("Code"="subjectID"))
PITtypemean.PREVENTmeta <- left_join(PITtypemean,PREVENTmeta,by = c("Code"="subjectID"))
PITtypemean.PREVENTmeta2 <- left_join(PITtypemean2,PREVENTmeta,by = c("Code"="subjectID"))
PITdistmean.PREVENTmeta <- left_join(PITdistmean,PREVENTmeta,by = c("Code"="subjectID"))
PITanglemean.PREVENTmeta <- left_join(PITanglemean,PREVENTmeta,by = c("Code"="subjectID"))

PITglobalmeanOOB.PREVENTmeta <- left_join(PITglobalmeanOOB,PREVENTmeta.full,by = c("Code"="subjectID"))
PITtypemeanOOB.PREVENTmeta <- left_join(PITtypemeanOOB,PREVENTmeta,by = c("Code"="subjectID"))
PITdistmeanOOB.PREVENTmeta <- left_join(PITdistmeanOOB,PREVENTmeta,by = c("Code"="subjectID"))
PITanglemeanOOB.PREVENTmeta <- left_join(PITanglemeanOOB,PREVENTmeta,by = c("Code"="subjectID"))

# make change in location error variable
PIT1 <- PITtypemean %>% select(Code,Type,meanADerror,meanAAerror,meanDdifferrorAbs) %>% filter(Type==1)
PIT2 <- PITtypemean %>% select(Code,Type,meanADerror,meanAAerror,meanDdifferrorAbs) %>% filter(Type==2)
PIT3 <- PITtypemean %>% select(Code,Type,meanADerror,meanAAerror,meanDdifferrorAbs) %>% filter(Type==3)
# for baseline > no distal cues
PITchange <- cbind(PIT1[,1],PIT3[,3] - PIT1[,3],PIT3[,4] - PIT1[,4],PIT3[,5] - PIT1[,5]) %>%
  mutate(change = case_when(meanADerror>=0 ~"Worsen",meanADerror<0 ~"Improve"))
PITchange.PREVENTmeta <- left_join(PITchange,PREVENTmeta,by=c("Code"="subjectID"))
# for baseline > no optic flow
PITchange2 <- cbind(PIT1[,1],PIT2[,3] - PIT1[,3],PIT2[,4] - PIT1[,4],PIT2[,5] - PIT1[,5]) %>%
  mutate(change = case_when(meanADerror>=0 ~"Worsen",meanADerror<0 ~"Improve"))
PITchange2.PREVENTmeta <- left_join(PITchange2,PREVENTmeta,by=c("Code"="subjectID"))

# make change OOB variable
PIT1 <- PITtypemeanOOB %>% select(Code,Type,meanADerror,meanOoBAAerror,meanDdifferrorAbs) %>% filter(Type==1)
PIT3 <- PITtypemeanOOB %>% select(Code,Type,meanADerror,meanOoBAAerror,meanDdifferrorAbs) %>% filter(Type==3)
PITchangeOOB <- cbind(PIT1[,1],PIT3[,3] - PIT1[,3],PIT3[,4] - PIT1[,4],PIT3[,5] - PIT1[,5]) %>%
  mutate(change = case_when(meanADerror>=0 ~"Worsen",meanADerror<0 ~"Improve"))
PITchangeOOB.PREVENTmeta <- left_join(PITchangeOOB,PREVENTmeta,by=c("Code"="subjectID"))


# filter summaries
PITtype3mean.PREVENTmeta2 <- filter(PITtypemean.PREVENTmeta2, Type == 3)
PITtype1mean.PREVENTmeta2 <- filter(PITtypemean.PREVENTmeta, Type == 1)
PITtype3mean.PREVENTmeta.male <- filter(PITtype3mean.PREVENTmeta2, genderLabs == "Male")
PITtype3mean.PREVENTmeta.female <- filter(PITtype3mean.PREVENTmeta2, genderLabs == "Female")
PITtype3mean.PREVENTmeta.FH <- filter(PITtype3mean.PREVENTmeta2, FH == 1)
PITtype3mean.PREVENTmeta.noFH <- filter(PITtype3mean.PREVENTmeta2, FH == 0)

# MRI subgroups
MRIsubsample <- PREVENTmeta.full %>% filter(MRI=='y')
PITall.MRI.clean.noOoB <- PITall.PREVENTmeta.clean.noOoB %>% filter(MRI=="y")

PITglobalmean.PREVENTmeta.MRI <- PITglobalmean.PREVENTmeta %>% filter(MRI=="y")
PITtypemean.PREVENTmeta.MRI <- PITtypemean.PREVENTmeta %>% filter(MRI=="y")
PITtypemean.PREVENTmeta2.MRI <- PITtypemean.PREVENTmeta2 %>% filter(MRI=="y")
PITtype3mean.MRI <- PITtype3mean.PREVENTmeta2 %>% filter(MRI=="y")
PITchangeOOB.PREVENTmeta.MRI <- filter(PITchangeOOB.PREVENTmeta, MRI=="y")

# median split change performance
medianChange <- median(PITchange.PREVENTmeta$meanADerror)
PITchange.PREVENTmeta <- PITchange.PREVENTmeta %>% mutate(PITLabs = case_when(meanADerror <= medianChange ~ "Low", 
                                                            meanADerror > medianChange ~ "High"))
PITchange.PREVENTmeta<- PITchange.PREVENTmeta %>% mutate(PITLabs=factor(PITLabs,levels=c("Low","High"),ordered = T))
```

# Compound risk variable
(this is a four way split of risk for visualisation purposes only)
```{r}
risk <- select(PREVENTmeta,"subjectID","FH","apoe4") %>% mutate("Multi-hereditary risk" = case_when(FH == 1 & apoe4 == 1 ~ "FH+/APOE-e4+",
                                                                                                    FH == 1 & apoe4 == 0 ~ "FH+/APOE-e4-",
                                                                                                    FH == 0 & apoe4 == 1 ~ "FH-/APOE-e4+",
                                                                                                    FH == 0 & apoe4 == 0 ~ "FH-/APOE-e4-")) 

risk <- select(risk,"subjectID","Multi-hereditary risk")
PITchange.PREVENTmeta <- left_join(PITchange.PREVENTmeta,risk,by = c("Code"="subjectID"))
PITchange2.PREVENTmeta <- left_join(PITchange2.PREVENTmeta,risk,by = c("Code"="subjectID"))
PITchangeOOB.PREVENTmeta  <- left_join(PITchangeOOB.PREVENTmeta,risk,by = c("Code"="subjectID"))
PITchange.PREVENTmeta$`Multi-hereditary risk` = factor(PITchange.PREVENTmeta$`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)
PITchange2.PREVENTmeta$`Multi-hereditary risk` = factor(PITchange2.PREVENTmeta$`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)
PITchangeOOB.PREVENTmeta$`Multi-hereditary risk` = factor(PITchangeOOB.PREVENTmeta$`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)

PITchange.PREVENTmeta.MRI <- filter(PITchange.PREVENTmeta, MRI=="y")
PITchange2.PREVENTmeta.MRI <- filter(PITchange2.PREVENTmeta, MRI=="y")

```

# Load allocentric angular data
below behavioral analyses were repeated using AngErrFull or PITchange.AngErrFull data sets which contains A) allocentric angular error and B) angular error calculated based on the position of the out of bounds collision (See supplementary materials)
```{r}
AngErrIN <- '/Users/ccnewton/Local\ Documents/ENCRYPT_data/AlloAngErr_v2.xlsx'
AngErr <- read_excel(AngErrIN) # manually rename codes to subjectID, manually combined from two matlab xlsx outputs

PREVENTvars <- select(PREVENTmeta,subjectID,FH,apoe4,DRS_noAP,genderLabs,encrypt_age,nbeduc,CAIDELabs_noAPOE)
PREVENTvars <- left_join(PREVENTvars,risk,by="subjectID")
AngErrFull <- left_join(AngErr,PREVENTvars,by="subjectID")
AngErrFull <-AngErrFull %>% mutate(TypeLab = case_when(Type == 1 ~ "No Change", 
                                                    Type == 2 ~ "No Distal Cues",
                                                    Type == 3 ~ "No Optic Flow"))
AngErrFull <- AngErrFull %>% mutate(TypeLab=factor(TypeLab,levels=c("No Change","No Optic Flow","No Distal Cues"),ordered = T)) %>%
  mutate(`Multi-hereditary risk` = factor(`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)) 

# make mean version with OOB separate
AngErrMeanOOB <-  AngErr %>% group_by(subjectID, Type,OutOfBound) %>% 
   summarise(meanAngErr = mean(AngleErr))

AngErrMeanOOBFull <- left_join(AngErrMeanOOB, PREVENTvars,by="subjectID")
AngErrMeanOOBFull <-AngErrMeanOOBFull %>% mutate(TypeLab = case_when(Type == 1 ~ "No Change", 
                                                    Type == 2 ~ "No Distal Cues",
                                                    Type == 3 ~ "No Optic Flow"))
AngErrMeanOOBFull<- AngErrMeanOOBFull%>% mutate(TypeLab=factor(TypeLab,levels=c("No Change","No Optic Flow","No Distal Cues"),ordered = T)) %>%
  mutate(`Multi-hereditary risk` = factor(`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)) 

# make mean version with OOB and normal trials together
AngErrMean <-  AngErr %>% group_by(subjectID, Type) %>% 
   summarise(meanAngErr = mean(AngleErr))

AngErrMeanFull <- left_join(AngErrMean, PREVENTvars,by="subjectID")
AngErrMeanFull <-AngErrMeanOOBFull %>% mutate(TypeLab = case_when(Type == 1 ~ "No Change", 
                                                    Type == 2 ~ "No Distal Cues",
                                                    Type == 3 ~ "No Optic Flow"))
AngErrMeanFull<- AngErrMeanOOBFull%>% mutate(TypeLab=factor(TypeLab,levels=c("No Change","No Optic Flow","No Distal Cues"),ordered = T)) %>%
  mutate(`Multi-hereditary risk` = factor(`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)) 


# make change version
PIT1 <- AngErrMean %>% filter(Type==1)
PIT3 <- AngErrMean %>% filter(Type==2)
PITchange.AngErr <- cbind(PIT1[,1],PIT3[,3] - PIT1[,3]) %>%
  mutate(change = case_when(meanAngErr>=0 ~"Worsen",meanAngErr<0 ~"Improve"))
PITchange.AngErrFull <- left_join(PITchange.AngErr,PREVENTvars,by="subjectID")
PITchange.AngErrFull<- PITchange.AngErrFull%>% 
  mutate(`Multi-hereditary risk` = factor(`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)) 

```

# Demographics
(used same code but swapped out variables e.g. age, education etc)

```{r}
range(PREVENTmeta.full$encrypt_age)

PREVENTmeta.full %>% 
  summarise(av = mean(encrypt_age, na.rm=FALSE), 
            sd = sd(encrypt_age,na.rm=FALSE))

PREVENTmeta.full %>% 
  group_by(FH) %>% 
  summarise(av = mean(encrypt_age, na.rm=FALSE), 
            sd = sd(encrypt_age,na.rm=FALSE))

filter(PITchange.PREVENTmeta,!is.na(apoe4)) %>% 
  group_by(`Multi-hereditary risk`) %>% 
  summarise(av = mean(DRS_noAP, na.rm=FALSE), 
            sd = sd(DRS_noAP,na.rm=FALSE))

normality <- PREVENTmeta.full %>%
  group_by(FH) %>%
  shapiro_test(encrypt_age)

ggqqplot(PREVENTmeta, 
         x="encrypt_age", 
         facet.by="FH")

t.test(encrypt_age~genderLabs,
       PREVENTmeta.full,var.equal=TRUE)
wilcox.test(encrypt_age~genderLabs,
            PREVENTmeta.full)

mean(PREVENTmeta.full$EYOD,na.rm=TRUE)

chisq.test(PREVENTmeta.full$genderLabs,PREVENTmeta.full$FH)

lm <- lm(data=filter(PITchange.PREVENTmeta,!is.na(`Multi-hereditary risk`)), encrypt_age ~ Risk)
lm <- lm(data=filter(PITchange.PREVENTmeta,!is.na(`Multi-hereditary risk`)), nbeduc ~ Risk)
lm <- lm(data=filter(PITchange.PREVENTmeta,!is.na(`Multi-hereditary risk`)), DRS_noAP ~ Risk)
anova(lm)
```

# Exclusion of 'out of bounds' trials
(repeated for different risk factors, chi-square test alone ultimately used, not GLM)

```{r}
FH_OOB.long <- select(PITall.PREVENTmeta, Code, genderLabs, nbeduc, encrypt_age, TrialNo, Type, OoB, FH)
FH_OOB <- FH_OOB.long %>% group_by(Code,FH,genderLabs) %>% summarise(OoB = sum(as.logical(OoB==1))) 
FH_OOB_Type <- FH_OOB.long %>% group_by(Code,FH,genderLabs,Type) %>% summarise(OoB = sum(as.logical(OoB==1))) 
FH_OOB <- FH_OOB %>% mutate(Total = 36)
FH_OOB_Type <- FH_OOB_Type %>% mutate(Total = 12)

chisq_test(FH_OOB.long$FH,FH_OOB.long$OoB)

# tried GLM
modAll_FH <- glm(cbind(OoB,Total - OoB) ~ FH*genderLabs*Type, data = FH_OOB_Type, family ="binomial") 
summary(modAll_FH)
anova(modAll_FH, test = "Chisq")
```

# -  
# - - BEHAVIOUR - -
# 1. PIT x risk

-Used linear mixed model to examine all repeated trials + conditions individually first, which was not significant  
-Then used linear regression for change in average performance per condition
- for location error, use ADerror
- for angular error, use AAerror
- for distance error, use DdifferrorAbs

### LMER (individual trials)

```{r}
# use sqrt because of skew 
lmer.all <- lmer(data=PITall.PREVENTmeta.noOoB.full, sqrt(ADerror) ~ FH * apoe4 * DRS_noAP * Type * genderLabs + encrypt_age + nbeduc + (Type | Code) + (Type | TrialNo), REML=FALSE)

ggqqplot(resid(lmer.SQRTADerror_FH.controls.Interaction3way))

anova(lmer.all) 
summary(lmer.all)
```

## LM (change in performance)

Linear regression
- for location error change, use meanADerror
- for angular error change, use meanAAerror
- for distance error change, use meanDdifferrorAbs
  
For baseline > no distal cues, use PITchange.PREVENTmeta  
For baseline > no optic flow, use PITchange2.PREVENTmeta  

### - - All risk factors
```{r}
# baseline > no distal cues
# location error
lm.all <- lm(data=PITchange.PREVENTmeta, meanADerror ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.all)
summary(lm.all)

emmeans(lm.all, specs = pairwise ~ FH * apoe4, adjust = "tukey",type="response",pbkrtest.limit = 3564)
emmeans(lm.all, specs = pairwise ~ FH * genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)
emmeans(lm.all, specs = pairwise ~ apoe4 * genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)
emmeans(lm.all, specs = pairwise ~ FH * apoe4 * genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)

# angular error
lm.all <- lm(data=PITchange.PREVENTmeta, meanAAerror ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.all)
summary(lm.all)


# distance error
lm.all <- lm(data=PITchange.PREVENTmeta, meanDdifferrorAbs ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.all)
summary(lm.all)


# baseline > no optic flow
# location error
lm.all <- lm(data=PITchange2.PREVENTmeta, meanADerror ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.all)
summary(lm.all)

emmeans(lm.all, specs = pairwise ~ FH * apoe4, adjust = "tukey",type="response",pbkrtest.limit = 3564)

# angular error
lm.all <- lm(data=PITchange2.PREVENTmeta, meanAAerror ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.all)
summary(lm.all)

# distance error
lm.all <- lm(data=PITchange2.PREVENTmeta, meanDdifferrorAbs ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.all)
summary(lm.all)
```


### - - CAIDE correlations

```{r}
# BASELINE > NO DISTAL CUES
# location error
cor.test(PITchange.PREVENTmeta$DRS_noAP,  PITchange.PREVENTmeta$meanADerror, method = "pearson")
hist(PITchange.PREVENTmeta$DRS_noAP)

# angular error
cor.test(PITchange.PREVENTmeta$DRS_noAP, PITchange.PREVENTmeta$meanAAerror, method = "pearson")

# distance error
cor.test(PITchange.PREVENTmeta$DRS_noAP, PITchange.PREVENTmeta$meanDdifferrorAbs, method = "pearson")

# BASELINE > NO OPTIC FLOW 
# location error
cor.test(PITchange2.PREVENTmeta$DRS_noAP, PITchange2.PREVENTmeta$meanADerror, method = "pearson")
# angular error
cor.test(PITchange2.PREVENTmeta$DRS_noAP, PITchange2.PREVENTmeta$meanAAerror, method = "pearson")
# distance error
cor.test(PITchange2.PREVENTmeta$DRS_noAP, PITchange2.PREVENTmeta$meanDdifferrorAbs, method = "pearson")
```

### - - Male EYOD (no distal cues)
For FH males only, given select behavioural findings on no distal cues condition
```{r}
lm.type3EYOD <- lm(data=filter(PITtype3mean.PREVENTmeta2, FH==1), meanADerror ~ EYOD + genderLabs + encrypt_age + nbeduc)
summary(lm.type3EYOD)
anova(lm.type3EYOD)

# location error
cor.test(PITtype3mean.PREVENTmeta.male$EYOD,PITtype3mean.PREVENTmeta.male$meanADerror)
cor.test(PITtype3mean.PREVENTmeta.male$encrypt_age,PITtype3mean.PREVENTmeta.male$meanADerror)
# angular error
cor.test(PITtype3mean.PREVENTmeta.male$EYOD,PITtype3mean.PREVENTmeta.male$meanAAerror)
cor.test(PITtype3mean.PREVENTmeta.male$encrypt_age,PITtype3mean.PREVENTmeta.male$meanAAerror)
# distance error
cor.test(PITtype3mean.PREVENTmeta.male$EYOD,PITtype3mean.PREVENTmeta.male$meanDdifferrorAbs)
cor.test(PITtype3mean.PREVENTmeta.male$encrypt_age,PITtype3mean.PREVENTmeta.male$meanDdifferrorAbs)
```



### Model comparison

```{r}
# 1. model comparison, risk only
lm.FH <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ FH + genderLabs + encrypt_age + nbeduc)
lm.apoe <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ apoe4 + genderLabs + encrypt_age + nbeduc)
lm.apoe.FH <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ apoe4*FH + genderLabs + encrypt_age + nbeduc)
lm.DRS <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ DRS_noAP + genderLabs + encrypt_age + nbeduc)
lm.all.compare <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ FH*apoe4*DRS_noAP + genderLabs + encrypt_age + nbeduc)

summary(lm.FH)
summary(lm.apoe)
summary(lm.apoe.FH)
summary(lm.DRS)
summary(lm.all.compare)

anova(lm.FH,lm.all.compare)
anova(lm.apoe,lm.all.compare)
anova(lm.apoe.FH,lm.all.compare)
anova(lm.DRS,lm.all.compare)

# 2. model comparison, risk * gender
lm.FH.gender <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ FH * genderLabs + encrypt_age + nbeduc)
lm.apoe.gender <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ apoe4 * genderLabs + encrypt_age + nbeduc)
lm.apoe.FH.gender <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ apoe4 * FH * genderLabs + encrypt_age + nbeduc)
lm.DRS.gender <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ DRS_noAP * genderLabs + encrypt_age + nbeduc)
lm.all.compare.gender <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
lm.all.compare.gender2 <- lm(data=filter(PITchange.PREVENTmeta,!is.na(FH),!is.na(apoe4),!is.na(DRS_noAP)), meanADerror ~ FH*apoe4*genderLabs + DRS_noAP + encrypt_age + nbeduc)

summary(lm.FH.gender)
summary(lm.apoe.gender)
summary(lm.apoe.FH.gender)
summary(lm.DRS.gender)
summary(lm.all.compare.gender)
summary(lm.all.compare.gender2)

anova(lm.FH.gender,lm.all.compare.gender)
anova(lm.apoe.gender,lm.all.compare.gender)
anova(lm.apoe.FH.gender,lm.all.compare.gender) # FH*APOE vs all with * DRS - no different
anova(lm.apoe.FH.gender,lm.all.compare.gender2) # FH*APOE vs all with + DRS - different
anova(lm.DRS.gender,lm.all.compare.gender)

# 3. compare models with and without gender interactions
anova(lm.all.compare,lm.all.compare.gender)

anova(lm.FH,lm.FH.gender)
anova(lm.apoe,lm.apoe.gender)
anova(lm.apoe.FH,lm.apoe.FH.gender)
anova(lm.DRS,lm.DRS.gender)

anova(lm.FH,lm.all.compare.gender)
anova(lm.apoe,lm.all.compare.gender)
anova(lm.apoe.FH,lm.all.compare.gender)
anova(lm.DRS,lm.all.compare.gender)

```

## Overturning
```{r}
ggboxplot(filter(AngErrMeanOOBFull,OutOfBound == 0),x="TypeLab",y="meanAngErr",
       palette = "jco", add='jitter',
       xlab = "Return condtion type", ylab = "All trial signed angular error (deg)",ggtheme=theme_minimal()) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```

## Out of bounds

```{r}
lm.all <- lm(data=PITchange.AngErrFull, meanAngErr ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.all)
summary(lm.all)
```



```{r}
p <- ggboxplot(AngErrMeanOOBFull,x="TypeLab",y="meanAngErr",
       palette = "jco", add='jitter',facet.by = "OutOfBound",
       xlab = "Return condtion type", ylab = "All trial signed angular error (deg)",ggtheme=theme_minimal()) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))

ggpar(p, ylim = c(-70,70))
```


```{r}
p <- ggboxplot(AngErrMeanFull,x="TypeLab",y="meanAngErr",
       palette = "jco", add='jitter',
       xlab = "Return condtion type", ylab = "All trial signed angular error (deg)",ggtheme=theme_minimal()) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
ggpar(p, ylim = c(-70,70))
```

# 2. Comparator tests x risk
## Allocentric
```{r}
lm.4MT <- lm(data=PREVENTmeta.full, 
                mount_task_total ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc + date_vi)
plot(lm.4MT)
anova(lm.4MT)
emmeans(lm.4MT, pairwise ~ FH, adjust="tukey",type="response")
```
## Egocentric
```{r}
lm.VRSTT <- lm(data=PREVENTmeta.full, 
                supm_task_total ~ FH * apoe4 * DRS_noAP * genderLabs + encrypt_age + nbeduc + date_vi)
plot(lm.VRSTT)
anova(lm.VRSTT)
```
## Episodic memory
narrative recall
```{r}
lm.NarRec <- lm(data=PREVENTmeta.full, 
                EP21T ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.NarRec)
```

name-face association
```{r}
lm.NameFace <- lm(data=PREVENTmeta.full, 
                EP18BN ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc)

anova(lm.NameFace)
summary(lm.NameFace)
cor.test(PREVENTmeta.full$DRS_noAP,PREVENTmeta.full$EP18BN)
```

## Visual short term binding
```{r}
lm.VSTBT <- lm(data=PREVENTmeta.full, 
                SHPCOLBINDING_PCR ~ FH*apoe4*DRS_noAP*genderLabs + encrypt_age + nbeduc + date_vi)
anova(lm.VSTBT)
```


# 3. ROC analysis on all tests

```{r}
library(mice)
library(glmnet)

dat <- PITchange.PREVENTmeta
dat$Risk<-factor(dat$Risk, levels = c("Low","High"))

# fit Risk https://glmnet.stanford.edu/articles/glmnet.html

NumVal <- 1000

#predictors <- cbind(dat$encrypt_age,dat$gender,dat$nbeduc,dat$meanADerror,dat$EP21T,dat$mount_task_total,dat$supm_task_total, dat$SHPCOLBINDING_PCR)
predictors <- cbind(dat$encrypt_age,dat$gender,dat$nbeduc)

NumPrd <- ncol(predictors)

auc <- matrix(data=NA, nrow=NumVal, ncol=1)
beta <- matrix(data=NA, nrow=NumVal, ncol=NumPrd+1) # +1 is intercept

for (val in 1:NumVal)
{
  set.seed(val*NumVal) 
  cfit <- cv.glmnet(predictors, dat$Risk, family = "binomial", type.measure = "auc", keep = TRUE, nfolds = 5)
#  plot(cfit)
#  print(cfit, label=T)
  print(val)
  ind <- which(cfit$cvm == max(cfit$cvm))
  auc[val] <- cfit$cvm[ind[1]]
  tmp <- coef(cfit) #, s = cfit$lambda[ind[1]])
  beta[val,] <- tmp[1:(NumPrd+1),1]
}

mauc <- mean(auc)
if (mauc < 0.5) {mauc <- 1 - mauc} # Assume labels inverted?
mauc

num <- matrix(data=NA, nrow = 1, ncol = NumPrd)
for (val in 1:NumPrd)
{
  num[1,val] <- length(which(beta[,val+1]!=0)) # +1 to ignore constant term
}
barplot(num)
num*100/NumVal

val <- which.min(abs(auc - mean(auc)))
set.seed(val*NumVal) 
cfit <- cv.glmnet(predictors, dat$Risk, family = "binomial", type.measure = "auc", keep = TRUE, nfolds = 5)
plot(cfit)
print(cfit, label=T)

rocs <- roc.glmnet(cfit$fit.preval, newy = dat$Risk)
# # roc.glmnet returns a list of cross-validated ROC data, one for each model along the path. The code below demonstrates how one can plot the output. The first line identifies the lambda value giving the best area under the curve (AUC). Then we plot all the ROC curves in grey and the ?winner? in red.
best <- cfit$index["min",]
plot(rocs[[best]], type = "l") #, asp = 1, xlim = c(0,1))
# invisible(sapply(rocs, lines, col="grey"))
lines(rocs[[best]], lwd = 2, col = "red")
lines(cbind(seq(0,1,0.01),seq(0,1,0.01)), lwd = 1, col = "black")

set.seed(5)

# Impute NA values
mtt <- mice(cbind(dat$mount_task_total, dat$encrypt_age, dat$gender, dat$nbedu)) # must not use variables of interest below
mtt <- complete(mtt,1) # Assume 1st imputation sufficient here
dat$mount_task_total <- mtt[,1]

mtt <- mice(cbind(dat$supm_task_total, dat$encrypt_age, dat$gender, dat$nbedu)) # must not use variables of interest below
mtt <- complete(mtt,1) # Assume 1st imputation sufficient here
dat$supm_task_total <- mtt[,1]


glm1 <- glm(Risk ~ encrypt_age + gender + nbeduc, data= dat, family = binomial)
glm2 <- glm(Risk ~ encrypt_age + gender + nbeduc + meanADerror, data= dat,family = binomial)
glm4 <- glm(Risk ~ encrypt_age + gender + nbeduc + EP21T, data= dat,family = binomial)
glm5 <- glm(Risk~ encrypt_age + gender + nbeduc + mount_task_total, data= dat,family = binomial)
glm6 <- glm(Risk~ encrypt_age + gender + nbeduc + supm_task_total, data= dat,family = binomial)
glm7 <- glm(Risk~ encrypt_age + gender + nbeduc + SHPCOLBINDING_PCR, data= dat,family = binomial)

null <- predict(glm1, newdata= dat)
LocationError <- predict(glm2, newdata= dat)
EpisodicMemory <- predict(glm4, newdata= dat)
Allocentric <- predict(glm5, newdata= dat)
Egocentric <- predict(glm6, newdata= dat)
VisualMemoryBinding <- predict(glm7, newdata= dat)

true.auc <- colAUC(cbind(null, LocationError, EpisodicMemory, Allocentric, Egocentric,VisualMemoryBinding),  dat$Risk, plotROC = T, alg = "ROC")

## Null permutation

NumVal <- 1000

null.auc <- matrix(data=NA, nrow=NumVal, ncol=6)

for (val in 1:NumVal)
{
  dat$SampRisk <- sample(dat$Risk)

  null                <- predict(glm(SampRisk ~ encrypt_age + gender + nbeduc, data = dat, family = binomial), newdata = dat)
  LocationError       <- predict(glm(SampRisk ~ encrypt_age + gender + nbeduc + meanADerror, data = dat, family = binomial), newdata = dat)
  EpisodicMemory      <- predict(glm(SampRisk ~ encrypt_age + gender + nbeduc + EP21T, data = dat, family = binomial), newdata = dat)
  Allocentric         <- predict(glm(SampRisk ~ encrypt_age + gender + nbeduc + mount_task_total, data = dat, family = binomial), newdata = dat)
  Egocentric          <- predict(glm(SampRisk ~ encrypt_age + gender + nbeduc + supm_task_total, data = dat, family = binomial), newdata = dat)
  VisualMemoryBinding <- predict(glm(SampRisk ~ encrypt_age + gender + nbeduc + SHPCOLBINDING_PCR, data = dat, family = binomial), newdata = dat)
  
  null.auc[val,1:6] <- colAUC(cbind(null, LocationError, EpisodicMemory, Allocentric, Egocentric, VisualMemoryBinding),  dat$SampRisk, plotROC = F, alg = "ROC")
  }

boxplot(null.auc)
summary(null.auc)
true.auc

for (val in 1:6)
  {
  print(val)
  print(quantile(null.auc[,val],.95))
  print(ecdf(null.auc[,val])(true.auc[,val]))
}

```



#-
# - - MRI STRUCTURE - -

## 1. Risk factors
A series of linear regression models exploring each ROI as a response and each risk factor as a predictor e.g. swapping FH for APOE or CAIDE or all
```{r}
modelsList <- list(lm.pmEC.FH = lm(data=MRIsubsample,pmEC_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.alEC.FH = lm(data=MRIsubsample,alEC_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.CA1.FH = lm(data=MRIsubsample,CA1_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.CA2.FH = lm(data=MRIsubsample,CA2_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.CA3.FH = lm(data=MRIsubsample,CA3_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.DG.FH = lm(data=MRIsubsample,DG_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.PrC.FH = lm(data=MRIsubsample,PrC_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.Sub.FH = lm(data=MRIsubsample,Sub_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.PhC.FH = lm(data=MRIsubsample,PhC_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.RSC.FH = lm(data=MRIsubsample,isthm_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc),
               lm.PCC.FH = lm(data=MRIsubsample,post_volume_cor ~ FH*apoe4*genderLabs + encrypt_age + nbeduc))
modelsAnova <- lapply(modelsList,anova)
lapply(modelsList,summary)
# cumbersome manual extraction of p value for risk factor into vector, I know it is terrible
pvec.FH = c(0.28,0.25,0.40,0.73,0.86,0.44,0.39,0.04,0.04,0.05,0.94)
pvec.FH.correct <- p.adjust(pvec.FH,"BH")
pvec.FH.correct
```


```{r}
MRIsubsample %>% group_by(FH,apoe4) %>% summarise(pmEC = mean(pmEC_volume_cor,na.rm=TRUE),
                                                  alEC = mean(alEC_volume_cor,na.rm=TRUE),
                                                  CA1 = mean(CA1_volume_cor,na.rm=TRUE),
                                                  CA2 = mean(CA2_volume_cor,na.rm=TRUE),
                                                  CA3 = mean(CA3_volume_cor,na.rm=TRUE),
                                                  DG = mean(DG_volume_cor,na.rm=TRUE),
                                                  PrC = mean(PrC_volume_cor,na.rm=TRUE),
                                                  Sub = mean(Sub_volume_cor,na.rm=TRUE),
                                                  PhC = mean(PhC_volume_cor,na.rm=TRUE),
                                                  RSC = mean(isthm_volume_cor,na.rm=TRUE),
                                                  PCC =mean(post_volume_cor,na.rm=TRUE))
```


## 2. Individual ROI x risk factors x PIT

```{r}
modelsListPIT <- list(lm.pmEC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ pmEC_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.alEC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ alEC_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.CA1.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ CA1_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.CA2.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ CA2_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.CA3.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ CA3_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.DG.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ DG_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.Sub.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ Sub_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.RSC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ isthm_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.PCC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ post_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.PrC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ PrC_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.PhC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanADerror ~ PhC_volume_cor*FH*genderLabs + encrypt_age + nbeduc))

modelsSummary <- lapply(modelsListPIT,summary)
modelsAnova<- lapply(modelsListPIT,anova)

# same as above - manually extract p values and correct
```

## 3. Multiple ROIs x PIT
```{r}
lm.allROIs <- lm(data=filter(PITchange.PREVENTmeta.MRI,!is.na(pmEC_volume_cor)), meanADerror ~ pmEC_volume_cor + 
                   alEC_volume_cor + CA1_volume_cor + CA2_volume_cor + CA3_volume_cor +
                   post_volume_cor + PrC_volume_cor + PhC_volume_cor + isthm_volume_cor +
                   Sub_volume_cor + DG_volume_cor + encrypt_age + nbeduc + genderLabs)
summary(lm.allROIs)

lm.null <- lm(data=filter(PITchange.PREVENTmeta.MRI,!is.na(pmEC_volume_cor)), meanADerror ~ encrypt_age + nbeduc + genderLabs)
anova(lm.allROIs,lm.null)
```


#-
# - - fMRI GRID ACTIVITY - -
## 1. Function x risk
```{r}
hist(MRIsubsample$GCmagnitude_allRuns_pmECDTI_right_6)

## Basic metrics of grid activity
# magnitude
t.test(MRIsubsample$GCmagnitude_allRuns_pmECDTI_right_6, mu = 0,alternative="greater")
# temporal stability
t.test(MRIsubsample$tStability_pmECDTI_right_6_av, mu = 50,alternative="greater")
# spatial stability
t.test(MRIsubsample$sStability_pmECDTI_right_6_av, mu = 0,alternative="greater")

# risk factors -multi
lm.multi <- lm(data = MRIsubsample, GCmagnitude_allRuns_pmECDTI_right_6 ~ FH * apoe4 * DRS_noAP * genderLabs + encrypt_age + nbeduc)
anova(lm.multi)

lm.multi <- lm(data = MRIsubsample, tStability_pmECDTI_right_6_av ~ FH * apoe4 * DRS_noAP * genderLabs + encrypt_age + nbeduc)
anova(lm.multi)

# volume control
ggscatter(MRIsubsample, x="rh_pmECDTI_volume", y="GCmagnitude_allRuns_pmEC_right_6",
          add="reg.line",conf.int=TRUE,
          xlab="pmEC volume",ylab="pmEC GLR magnitude") +
  stat_cor(method="pearson")

# tSNR control
ggscatter(MRIsubsample, x="tSNR_pmECDTI_right_6", y="GCmagnitude_allRuns_pmECDTI_right_6",
          add="reg.line",conf.int=TRUE, xlab="tSNR", ylab="Magnitude of grid cell like representations") +
  stat_cor(method="pearson")

```

```{r}
PITchangelow <- filter(PITchange.PREVENTmeta, PITLabs == "Low",MRI=="y")
PITchangelow.male <- filter(PITchange.PREVENTmeta, PITLabs == "Low",MRI=="y",genderLabs == "Male")
PITchangehigh <- filter(PITchange.PREVENTmeta, PITLabs == "High",MRI=="y")
t.test(PITchangelow$GCmagnitude_allRuns_pmECDTI_right_6, mu = 0,alternative="greater")
t.test(PITchangehigh$GCmagnitude_allRuns_pmECDTI_right_6, mu = 0,alternative="greater")

t.test(data=filter(PITchange.PREVENTmeta, MRI=="y"), GCmagnitude_allRuns_pmECDTI_right_6~PITLabs)
```

## 2. Function x PIT

```{r}
lm.GCchange <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6 + 
                       nbeduc + encrypt_age + genderLabs)
summary(lm.GCchange)
```

```{r}
ggscatter(PITchange.PREVENTmeta.MRI, x="GCmagnitude_allRuns_pmECDTI_right_6",y="meanADerror",
          add = "reg.line",conf.int = TRUE,palette="jco",
          title = "6-fold Model",
          xlab = "Magnitude of grid cell like representations", ylab = "Change in location error (m)") +
  stat_cor(method="spearman")
```

## 3. Function x PIT x Risk

Again exchange below FH factor for apoe4 or Risk (multifactor two-way)

#### Linear regression

```{r}
lm.GCchange <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6*FH*apoe4*DRS_noAP*genderLabs + nbeduc + encrypt_age)
summary(lm.GCchange)
anova(lm.GCchange)
# no effect in full model

lm.GCchange.FH<- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6*FH*genderLabs + nbeduc + encrypt_age)
anova(lm.GCchange.FH)

lm.GCchange.apoe4<- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6*apoe4*genderLabs + nbeduc + encrypt_age)
anova(lm.GCchange.apoe4)
```


### CAIDE interactions

```{r}
lm_ADerror<-lm(data=PITchange.PREVENTmeta.MRI, meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_6 * DRS_noAP + encrypt_age + nbeduc + genderLabs)
summary(lm_ADerror)
anova(lm_ADerror)

interact_plot(lm_ADerror, pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP, interval = TRUE,
              x.label = "fMRI grid cell activity magnitude",
              y.label = "Change in location error (m)",
              legend.main = "CAIDE") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
      legend.title = element_text(size=12),
      legend.text = element_text(size=12))

object <- johnson_neyman(model = lm_ADerror,pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP) 
object$plot + xlab("CAIDE") + ylab("Beta regression value") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
      legend.title = element_text(size=12),
      legend.text = element_text(size=12))

sim_slopes(lm_ADerror, pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP, jnplot = TRUE) 
```


#### Model comparison

```{r}
# FH
lm.changeFH <- lm(data=filter(PITchange.PREVENTmeta.MRI,!is.na(GCmagnitude_allRuns_pmECDTI_right_6)), meanADerror ~ FH * genderLabs + encrypt_age + nbeduc) #null model, no fMRI
lm.GCchange.FH <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6*FH*genderLabs + nbeduc + encrypt_age) # model of interest with fMRI

anova(lm.changeFH, lm.GCchange.FH)

# APOE
lm.changeAPOE <- lm(data=filter(PITchange.PREVENTmeta.MRI,!is.na(GCmagnitude_allRuns_pmECDTI_right_6)), meanADerror ~ apoe4 * genderLabs + encrypt_age + nbeduc) #null model, no fMRI
lm.GCchange.apoe4<- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6*apoe4*genderLabs + nbeduc + encrypt_age)

anova(lm.changeAPOE, lm.GCchange.apoe4)

# CAIDE
lm.change.DRS <-lm(data=filter(PITchange.PREVENTmeta.MRI,!is.na(GCmagnitude_allRuns_pmECDTI_right_6)), meanADerror ~ DRS_noAP + encrypt_age + nbeduc + genderLabs)
lm.GCchange.DRS <-lm(data=filter(PITchange.PREVENTmeta.MRI,!is.na(GCmagnitude_allRuns_pmECDTI_right_6)), meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_6 * DRS_noAP + encrypt_age + nbeduc + genderLabs)

anova(lm.change.DRS, lm.GCchange.DRS)
```

#### Control models
Comparing 5fold and 7fold grid cell activity to show the 6fold has the greatest effect, in line with principles of grid cell function
```{r}
lm.GCchange5.FH <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_5*FH*genderLabs + nbeduc + encrypt_age)
summary(lm.GCchange5.FH)
anova(lm.GCchange5.FH)

lm.GCchange7.FH <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_7*Risk*genderLabs + nbeduc + encrypt_age)
summary(lm.GCchange7.FH)
anova(lm.GCchange7.FH)

lm_ADerror<-lm(data=PITchange.PREVENTmeta.MRI, meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_5 * DRS_noAP)
summary(lm_ADerror)
anova(lm_ADerror)

lm_ADerror<-lm(data=PITchange.PREVENTmeta.MRI, meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_7 * DRS_noAP)
summary(lm_ADerror)
anova(lm_ADerror)

```

```{r}
ggscatter(filter(PITchange.PREVENTmeta.MRI,!is.na(CAIDELabs_noAPOE)), x="GCmagnitude_allRuns_pmECDTI_right_7",y="meanADerror",
          add = "reg.line",conf.int = TRUE,palette="jco",facet.by = "CAIDELabs_noAPOE",
          title = "Association of pmEC Grid signal with change in angular error",
          xlab = "GLRs magnitude", ylab = "Change in angular error (deg)") +
  stat_cor(method="pearson")
```

#-
# - - PLOTS - - 

## Panel 1

```{r}
ggscatter(PITchange.PREVENTmeta, x="DRS_noAP",y="meanADerror",
          add = "reg.line",conf.int = TRUE,color="#3B3B3B",
          xlab = "CAIDE DRS", ylab = "Change in location error (m)",ggtheme=theme_minimal()) +
  stat_cor(method="pearson") +
  theme(strip.text = element_text(size=18),
        axis.text.x = element_text(size=15),
        axis.text.y = element_text(size=15),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18))
```



```{r}
p <- ggbarplot(filter(PITchange.PREVENTmeta, !is.na(apoe4)), x="Multi-hereditary risk",y="meanADerror",color="Multi-hereditary risk",fill="Multi-hereditary risk",add=c("mean_se","jitter"),ylab = "Change in location error, no distal cues (m)",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC","#003C67","#EFC000")) +
  scale_fill_manual(values=c("#003C6766","#4A699066","#7AA6DC66","#EFC00066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
ggpar(p,ylim=c(-1,1.9))
```

```{r}
p <- ggbarplot(filter(PITchange2.PREVENTmeta, !is.na(apoe4)), x="Multi-hereditary risk",y="meanADerror",color="Multi-hereditary risk",fill="Multi-hereditary risk",add=c("mean_se","jitter"),ylab = "Change in location error, no optic flow (m)",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC","#003C67","#EFC000")) +
  scale_fill_manual(values=c("#003C6766","#4A699066","#7AA6DC66","#EFC00066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
ggpar(p,ylim=c(-1,1.9))
```


```{r}
p <- ggbarplot(filter(PITchange.PREVENTmeta, !is.na(apoe4)), x="Multi-hereditary risk",y="meanADerror",color="Multi-hereditary risk",fill="Multi-hereditary risk",add=c("mean_se","jitter"),ylab = "Change in location error, no distal cues (m)",facet.by="genderLabs",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC","#003C67","#EFC000")) +
  scale_fill_manual(values=c("#003C6766","#4A699066","#7AA6DC66","#EFC00066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
ggpar(p,ylim=c(-1,1.9))
```

## Panel 2

```{r}
ggscatter(PITchange.PREVENTmeta, x="DRS_noAP",y="meanAAerror",
          add = "reg.line",conf.int = TRUE,color="#3B3B3B",
          title = "CAIDE association with change in angular error",
          xlab = "CAIDE DRS", ylab = "Change in angular error, no distal cues (deg)",ggtheme=theme_minimal()) +
  stat_cor(method="pearson") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```
```{r}
ggscatter(PITchange.PREVENTmeta, x="DRS_noAP",y="meanDdifferrorAbs",
          add = "reg.line",conf.int = TRUE,color="#3B3B3B",
          title = "CAIDE association with change in distance error",
          xlab = "CAIDE DRS", ylab = "Change in distance error, no distal cues (m)",ggtheme=theme_minimal()) +
  stat_cor(method="pearson") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```

```{r}
ggbarplot(filter(PITchange.PREVENTmeta, !is.na(apoe4)), x="Multi-hereditary risk",y="meanAAerror",color="Multi-hereditary risk",fill="Multi-hereditary risk",add=c("mean_se","jitter"),ylab = "Change in angular error, no distal cues (deg)",facet.by="genderLabs",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC","#003C67","#EFC000")) +
  scale_fill_manual(values=c("#003C6766","#4A699066","#7AA6DC66","#EFC00066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))

```

```{r}
ggbarplot(filter(PITchange.PREVENTmeta, !is.na(apoe4)), x="Multi-hereditary risk",y="meanDdifferrorAbs",color="Multi-hereditary risk",fill="Multi-hereditary risk",add=c("mean_se","jitter"),ylab = "Change in distance error, no distal cues (m)",facet.by="genderLabs",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC","#003C67","#EFC000")) +
  scale_fill_manual(values=c("#003C6766","#4A699066","#7AA6DC66","#EFC00066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))

```

## Panel 3

```{r}
ggscatter(filter(PITchange.PREVENTmeta,MRI=="y"), x="GCmagnitude_allRuns_pmECDTI_right_6",y="meanADerror",
          add = "reg.line",conf.int = TRUE,palette="jco",color="Risk", facet.by = "genderLabs",
          title = "Association of pmEC Grid signal with change in location error",
          xlab = "Magnitude of fMRI grid-like representations", ylab = "Change in location error (m)") +
  stat_cor(aes(color=Risk),method="pearson",label.y.npc = "top",label.x.npc="middle")
```

```{r}
lm_ADerror<-lm(data=PITchange.PREVENTmeta.MRI, meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_6 * DRS_noAP + encrypt_age + nbeduc + genderLabs)
summary(lm_ADerror)
anova(lm_ADerror)

interact_plot(lm_ADerror, pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP, interval = TRUE,
              x.label = "fMRI grid cell activity magnitude",
              y.label = "Change in location error (m)",
              legend.main = "CAIDE") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
      legend.title = element_text(size=12),
      legend.text = element_text(size=12))

object <- johnson_neyman(model = lm_ADerror,pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP) 
object$plot + xlab("CAIDE") + ylab("Beta regression value") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
      legend.title = element_text(size=12),
      legend.text = element_text(size=12))
```



