---
title: "ENCRYPT_Science_code"
author: "C Newton"
date: "2022-11-15"
output: pdf_document
---

KEY INFO
* 12 Trials repeated in 3 blocks, with different return condition/environment type      
* Risk stratification either  
  A) individual factor:  
    - Family history (FH)  
    - APOE-e4 status (apoe4)  
    - CAIDE score, continuous (DRS_noAP) or binary below/above median (CAIDELabs_noAPOE)  
  B) multifactor:  
    - Two-way (FH+/APOE-e4+ vs everyone else)  
    - Four-way (FH+/APOE-e4+, FH+/APOE-e4-, FH-/APOE-e4+, FH-/APOE-e4-)  
* When examining PIT, either used performance per trial/condition (PITall data sets) or mean performance per condition (PITtypemean data sets) or change in mean performance across conditions (PITchange data sets)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# load environment
library(ggplot2)
library(tidyverse)
library(data.table)
library(readxl)
library(RColorBrewer)
library(ggthemes)
library(ggsignif)
library(lme4)
library(emmeans)
library(knitr)
library(ggpubr)
library(rstatix)
library(colorspace)
library(readr)
library(interactions)
```



# Variables
```{r,include=FALSE}
## PIT
PITall <- read_csv('/Users/ccnewton/Local\ Documents/ENCRYPT_data/PIT/PITall_n100.csv')
# round numbers
PITall <- PITall %>% mutate(across(where(is.numeric), ~ round(., 2)))
# make new variables
PITall[,24:26] <- round(PITall[,24:26],1)
PITall[,34] <- round(PITall[,34],0)
PITall$AngleIncomBin <- cut_interval(PITall$AngleIncomAbs,length = 5)
PITall <- PITall %>% mutate(DistIncomCat = as_factor(DistIncom), DistOutCat = as_factor(DistOut),AngleIncomAbsCat = as_factor(AngleIncomAbs))
PITall <- PITall %>% mutate(across(c(1:6,29,30,31,33),as_factor))

# separate outcomes with and without missing subjects
PITall.full <- PITall
PITall <- PITall %>% filter(Code != "CB045")

## PREVENT - load in file from PREVENTmetadata_2_ENCRYPT.R
PREVENTmeta = read_csv('/Users/ccnewton/Local\ Documents/ENCRYPT_data/PREVENT/PREVENTdata_ENCRYPTn100.csv')
PREVENTmeta <- PREVENTmeta %>% mutate(across(c(1,2,3,8,9,563,564,567,568,677,708,712,757:763),as_factor))
PREVENTmeta.full <- PREVENTmeta
PREVENTmeta <- PREVENTmeta %>% filter(subjectID != "CB045")
PREVENTmeta.clean <- filter(PREVENTmeta, !is.na(apoe4))

# make custom colour palettes
myOrange = brewer.pal(n=9,"Oranges")[3:6]
myBlue = brewer.pal(n=9,"Blues")[3:6]
options(digits=3)
options(scipen = 999) 
# custom functions
standard_error <- function(x) sd(x) / sqrt(length(x))

## COMBINE
PITall.PREVENTmeta <- left_join(PITall,PREVENTmeta,by = c("Code"="subjectID"))
PITall.PREVENTmeta.full <- left_join(PITall.full,PREVENTmeta.full,by = c("Code"="subjectID"))
PITall.PREVENTmeta.clean <- PITall.PREVENTmeta %>% filter(!is.na(apoe4))

## REMOVE OUT OF BOUNDS TRIALS
PITall.PREVENTmeta.noOoB <- PITall.PREVENTmeta %>% filter(OoB == 0)
PITall.PREVENTmeta.noOoB.full <- PITall.PREVENTmeta.full %>% filter(OoB == 0)
PITall.noOoB <- PITall %>% filter(OoB==0)
PITall.PREVENTmeta.clean.noOoB <- PITall.PREVENTmeta %>% filter(OoB == 0) %>% filter(!is.na(apoe4))
PITall.MRI.clean.noOoB <- PITall.PREVENTmeta.clean.noOoB %>% filter(MRI=="y")

## SUMMARY VARIABLES
# average per condition or block
PITglobalmean <- filter(PITall.full,OoB == 0) %>% 
  group_by(Code) %>%
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITblockmean <- filter(PITall,OoB == 0) %>% 
  group_by(Code, Block) %>% 
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITtypemean <- filter(PITall,OoB == 0,Code!="WL208") %>% 
  group_by(Code, Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITtypemean2 <- filter(PITall.full,OoB == 0) %>% 
  group_by(Code, Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITdistmean <- filter(PITall,OoB == 0) %>% 
  group_by(Code, DistIncomCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITdistmean$DistIncom <- as.numeric(as.character(PITdistmean$DistIncomCat))
PITanglemean <- filter(PITall,OoB == 0) %>% 
  group_by(Code, AngleIncomAbsCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITanglemean$AngleIncom <- as.numeric(as.character(PITanglemean$AngleIncomAbsCat))
# as above with  OOB
PITglobalmeanOOB <- PITall.full %>% group_by(Code) %>%
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITblockmeanOOB <-  PITall %>% group_by(Code, Block) %>% 
  summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITtypemeanOOB <-  PITall %>% group_by(Code, Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITdistmeanOOB <-  PITall %>% group_by(Code, DistIncomCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))
PITanglemeanOOB <-  PITall %>% group_by(Code, AngleIncomAbsCat,Type) %>% 
   summarise(meanADerror = mean(ADerror), sdADerror  = sd(ADerror), 
            meanAAerror = mean(AAerror), sdAAerror = sd(AAerror), 
            meanPDerror = mean(PDerror), meanPAerror = mean(PAerror),
            meanOoBAAerror = mean(OoB_AAerror), sdOoBAAerror = sd(OoB_AAerror),
            seADerror = standard_error(ADerror), seAAerror = standard_error(AAerror),
            meanDdifferrorAbs = mean(DdifferrorAbs), sdDdifferrorAbs = sd(DdifferrorAbs))

# Combine summaries
PITglobalmean.PREVENTmeta <- left_join(PITglobalmean,PREVENTmeta.full,by = c("Code"="subjectID"))
PITtypemean.PREVENTmeta <- left_join(PITtypemean,PREVENTmeta,by = c("Code"="subjectID"))
PITtypemean.PREVENTmeta2 <- left_join(PITtypemean2,PREVENTmeta,by = c("Code"="subjectID"))
PITdistmean.PREVENTmeta <- left_join(PITdistmean,PREVENTmeta,by = c("Code"="subjectID"))
PITanglemean.PREVENTmeta <- left_join(PITanglemean,PREVENTmeta,by = c("Code"="subjectID"))

PITglobalmeanOOB.PREVENTmeta <- left_join(PITglobalmeanOOB,PREVENTmeta.full,by = c("Code"="subjectID"))
PITtypemeanOOB.PREVENTmeta <- left_join(PITtypemeanOOB,PREVENTmeta,by = c("Code"="subjectID"))
PITdistmeanOOB.PREVENTmeta <- left_join(PITdistmeanOOB,PREVENTmeta,by = c("Code"="subjectID"))
PITanglemeanOOB.PREVENTmeta <- left_join(PITanglemeanOOB,PREVENTmeta,by = c("Code"="subjectID"))

# make change in location error variable
PIT1 <- PITtypemean %>% select(Code,Type,meanADerror,meanAAerror,meanDdifferrorAbs) %>% filter(Type==1)
PIT2 <- PITtypemean %>% select(Code,Type,meanADerror,meanAAerror,meanDdifferrorAbs) %>% filter(Type==2)
PIT3 <- PITtypemean %>% select(Code,Type,meanADerror,meanAAerror,meanDdifferrorAbs) %>% filter(Type==3)
# for baseline > no distal cues
PITchange <- cbind(PIT1[,1],PIT3[,3] - PIT1[,3],PIT3[,4] - PIT1[,4],PIT3[,5] - PIT1[,5]) %>%
  mutate(change = case_when(meanADerror>=0 ~"Worsen",meanADerror<0 ~"Improve"))
PITchange.PREVENTmeta <- left_join(PITchange,PREVENTmeta,by=c("Code"="subjectID"))
# for baseline > no optic flow
PITchange2 <- cbind(PIT1[,1],PIT2[,3] - PIT1[,3],PIT2[,4] - PIT1[,4],PIT2[,5] - PIT1[,5]) %>%
  mutate(change = case_when(meanADerror>=0 ~"Worsen",meanADerror<0 ~"Improve"))
PITchange2.PREVENTmeta <- left_join(PITchange2,PREVENTmeta,by=c("Code"="subjectID"))

# make change OOB variable
PIT1 <- PITtypemeanOOB %>% select(Code,Type,meanADerror,meanOoBAAerror,meanDdifferrorAbs) %>% filter(Type==1)
PIT3 <- PITtypemeanOOB %>% select(Code,Type,meanADerror,meanOoBAAerror,meanDdifferrorAbs) %>% filter(Type==3)
PITchangeOOB <- cbind(PIT1[,1],PIT3[,3] - PIT1[,3],PIT3[,4] - PIT1[,4],PIT3[,5] - PIT1[,5]) %>%
  mutate(change = case_when(meanADerror>=0 ~"Worsen",meanADerror<0 ~"Improve"))
PITchangeOOB.PREVENTmeta <- left_join(PITchangeOOB,PREVENTmeta,by=c("Code"="subjectID"))


# filter summaries
PITtype3mean.PREVENTmeta2 <- filter(PITtypemean.PREVENTmeta2, Type == 3)
PITtype1mean.PREVENTmeta2 <- filter(PITtypemean.PREVENTmeta, Type == 1)
PITtype3mean.PREVENTmeta.male <- filter(PITtype3mean.PREVENTmeta2, genderLabs == "Male")
PITtype3mean.PREVENTmeta.female <- filter(PITtype3mean.PREVENTmeta2, genderLabs == "Female")
PITtype3mean.PREVENTmeta.FH <- filter(PITtype3mean.PREVENTmeta2, FH == 1)
PITtype3mean.PREVENTmeta.noFH <- filter(PITtype3mean.PREVENTmeta2, FH == 0)

# MRI subgroups
MRIsubsample <- PREVENTmeta.full %>% filter(MRI=='y')
PITall.MRI.clean.noOoB <- PITall.PREVENTmeta.clean.noOoB %>% filter(MRI=="y")

PITglobalmean.PREVENTmeta.MRI <- PITglobalmean.PREVENTmeta %>% filter(MRI=="y")
PITtypemean.PREVENTmeta.MRI <- PITtypemean.PREVENTmeta %>% filter(MRI=="y")
PITtypemean.PREVENTmeta2.MRI <- PITtypemean.PREVENTmeta2 %>% filter(MRI=="y")
PITtype3mean.MRI <- PITtype3mean.PREVENTmeta2 %>% filter(MRI=="y")
PITchangeOOB.PREVENTmeta.MRI <- filter(PITchangeOOB.PREVENTmeta, MRI=="y")
```

# Compound risk variable
(this is a four way split of risk, and is in addition to a two-way split of risk already present in PREVENTmeta which is 'high' - FH+/APOE+ and 'low' - any other combination. This four-way split is included for more fine grained analysis of indepedent and additive effects of hereditary factors)
```{r}
risk <- select(PREVENTmeta,"subjectID","FH","apoe4") %>% mutate("Multi-hereditary risk" = case_when(FH == 1 & apoe4 == 1 ~ "FH+/APOE-e4+",
                                                                                                    FH == 1 & apoe4 == 0 ~ "FH+/APOE-e4-",
                                                                                                    FH == 0 & apoe4 == 1 ~ "FH-/APOE-e4+",
                                                                                                    FH == 0 & apoe4 == 0 ~ "FH-/APOE-e4-")) 

risk <- select(risk,"subjectID","Multi-hereditary risk")
PITchange.PREVENTmeta <- left_join(PITchange.PREVENTmeta,risk,by = c("Code"="subjectID"))
PITchangeOOB.PREVENTmeta  <- left_join(PITchangeOOB.PREVENTmeta,risk,by = c("Code"="subjectID"))
PITchange.PREVENTmeta$`Multi-hereditary risk` = factor(PITchange.PREVENTmeta$`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)
PITchangeOOB.PREVENTmeta$`Multi-hereditary risk` = factor(PITchangeOOB.PREVENTmeta$`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)

PITchange.PREVENTmeta.MRI <- filter(PITchange.PREVENTmeta, MRI=="y")
PITchange2.PREVENTmeta.MRI <- filter(PITchange2.PREVENTmeta, MRI=="y")

```

# Load allocentric angular data
below behavioral analyses were repeated using AngErrFull or PITchange.AngErrFull data sets which contains A) allocentric angular error and B) angular error calculated based on the position of the out of bounds collision (See supplementary materials)
```{r}
AngErrIN <- '/Users/ccnewton/Local\ Documents/ENCRYPT_data/AlloAngErr_v2.xlsx'
AngErr <- read_excel(AngErrIN) # manually rename codes to subjectID, manually combined from two matlab xlsx outputs

PREVENTvars <- select(PREVENTmeta,subjectID,FH,apoe4,DRS_noAP,genderLabs,encrypt_age,nbeduc,CAIDELabs_noAPOE)
PREVENTvars <- left_join(PREVENTvars,risk,by="subjectID")
AngErrFull <- left_join(AngErr,PREVENTvars,by="subjectID")
AngErrFull <-AngErrFull %>% mutate(TypeLab = case_when(Type == 1 ~ "No Change", 
                                                    Type == 2 ~ "No Distal Cues",
                                                    Type == 3 ~ "No Optic Flow"))
AngErrFull <- AngErrFull %>% mutate(TypeLab=factor(TypeLab,levels=c("No Change","No Optic Flow","No Distal Cues"),ordered = T)) %>%
  mutate(`Multi-hereditary risk` = factor(`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)) 

# make mean version
AngErrMeanOOB <-  AngErr %>% group_by(subjectID, Type) %>% 
   summarise(meanAngErr = mean(AngleErr))
AngErrMeanOOBFull <- left_join(AngErrMeanOOB, PREVENTvars,by="subjectID")

AngErrMeanOOBFull <-AngErrMeanOOBFull %>% mutate(TypeLab = case_when(Type == 1 ~ "No Change", 
                                                    Type == 2 ~ "No Distal Cues",
                                                    Type == 3 ~ "No Optic Flow"))
AngErrMeanOOBFull<- AngErrMeanOOBFull%>% mutate(TypeLab=factor(TypeLab,levels=c("No Change","No Optic Flow","No Distal Cues"),ordered = T)) %>%
  mutate(`Multi-hereditary risk` = factor(`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)) 

# make change version
PIT1 <- AngErrMeanOOB %>% filter(Type==1)
PIT3 <- AngErrMeanOOB %>% filter(Type==2)
PITchange.AngErr <- cbind(PIT1[,1],PIT3[,3] - PIT1[,3]) %>%
  mutate(change = case_when(meanAngErr>=0 ~"Worsen",meanAngErr<0 ~"Improve"))
PITchange.AngErrFull <- left_join(PITchange.AngErr,PREVENTvars,by="subjectID")
PITchange.AngErrFull<- PITchange.AngErrFull%>% 
  mutate(`Multi-hereditary risk` = factor(`Multi-hereditary risk`, levels=c("FH-/APOE-e4-","FH-/APOE-e4+","FH+/APOE-e4-","FH+/APOE-e4+"),ordered = T)) 

```

# Demographics
(used same code but swapped out variables e.g. age, education etc)

```{r}
range(PREVENTmeta.full$encrypt_age)

PREVENTmeta.full %>% 
  summarise(av = mean(encrypt_age, na.rm=FALSE), 
            sd = sd(encrypt_age,na.rm=FALSE))

PREVENTmeta.full %>% 
  group_by(FH) %>% 
  summarise(av = mean(encrypt_age, na.rm=FALSE), 
            sd = sd(encrypt_age,na.rm=FALSE))

filter(PITchange.PREVENTmeta,!is.na(apoe4)) %>% 
  group_by(`Multi-hereditary risk`) %>% 
  summarise(av = mean(encrypt_age, na.rm=FALSE), 
            sd = sd(encrypt_age,na.rm=FALSE))

normality <- PREVENTmeta.full %>%
  group_by(FH) %>%
  shapiro_test(encrypt_age)

ggqqplot(PREVENTmeta, 
         x="encrypt_age", 
         facet.by="FH")

t.test(encrypt_age~genderLabs,
       PREVENTmeta.full,var.equal=TRUE)
wilcox.test(encrypt_age~genderLabs,
            PREVENTmeta.full)

mean(PREVENTmeta.full$EYOD,na.rm=TRUE)

chisq.test(PREVENTmeta.full$genderLabs,PREVENTmeta.full$FH)
```

# Exclusion of 'out of bounds' trials
(repeated for different risk factors, chi-square test alone ultimately used, not GLM)

```{r}
FH_OOB.long <- select(PITall.PREVENTmeta, Code, genderLabs, nbeduc, encrypt_age, TrialNo, Type, OoB, FH)
FH_OOB <- FH_OOB.long %>% group_by(Code,FH,genderLabs) %>% summarise(OoB = sum(as.logical(OoB==1))) 
FH_OOB_Type <- FH_OOB.long %>% group_by(Code,FH,genderLabs,Type) %>% summarise(OoB = sum(as.logical(OoB==1))) 
FH_OOB <- FH_OOB %>% mutate(Total = 36)
FH_OOB_Type <- FH_OOB_Type %>% mutate(Total = 12)

chisq_test(FH_OOB.long$FH,FH_OOB.long$OoB)

# tried GLM
modAll_FH <- glm(cbind(OoB,Total - OoB) ~ FH*genderLabs*Type, data = FH_OOB_Type, family ="binomial") 
summary(modAll_FH)
anova(modAll_FH, test = "Chisq")
```

# - - BEHAVIOUR - -
# 1. Family history/APOE
(repeat all below code swapping FH with apoe4)

## PIT
-Linear mixed model for all trials + conditions
-reported as not significant
- for location error, use ADerror
- for angular error, use AAerror
- for distance error, use DdifferrorAbs
```{r}
# use sqrt because of skew 
lmer.SQRTADerror_FH.controls.Interaction3way <- lmer(data=PITall.PREVENTmeta.noOoB.full, sqrt(ADerror) ~ FH * Type * genderLabs + DistIncom + AngleIncomAbs + encrypt_age + nbeduc + (Type | Code) + (1 | TrialNo), REML=FALSE)

ggqqplot(resid(lmer.SQRTADerror_FH.controls.Interaction3way))
plot(lmer.ADerror_FH.controls.Interaction3way) # use sqrt

anova(lmer.SQRTADerror_FH.controls.Interaction3way,type=3) 
summary(lmer.SQRTADerror_FH.controls.Interaction3way) # siginifcant FH:Type and trend FH:Type:gender

emmADerroTypeFH <- emmeans(lmer.SQRTADerror_FH.controls.Interaction3way, ~ Type * FH, adjust = "tukey",type="response")
emmADerroTypeFHsex <- emmeans(lmer.SQRTADerror_FH.controls.Interaction3way, ~ Type * FH * genderLabs, adjust = "tukey",type="response")
```

Plot change in performance across trials
```{r}
ADerroTypeFH <- emmip(emmADerroTypeFH, Type ~ FH, CIs = TRUE, plotit=FALSE)
ADerroTypeFH 
ADerroTypeFH$yvar.c <- ADerroTypeFH$yvar - mean(ADerroTypeFH$yvar)
```
 
```{r}
p <- ggplot(ADerroTypeFH, aes(x=Type,y=yvar.c,fill=FH,color=FH)) +
  geom_bar(stat="identity",position="dodge") +
  geom_errorbar(position=position_dodge(.9), width=.25,
                aes(ymax=yvar.c+SE,ymin=yvar.c-SE), 
                alpha=0.8)+ # add standard error bars according to mean centred predicted values
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
#  geom_signif(y_position = 0.25,
#             xmin=1+0.23,
#             xmax=3+0.25,
#             annotation = "p<0.001", tip_length = 0) +
  scale_color_manual(values=c("#0073C2","#EFC000")) +
  scale_fill_manual(values=c("#0073C266","#EFC00066"))
ggpar(p,
      xlab = "Return condition type",
      ylab = "Relative change in location error (m)",
      legend.title = "Family history status") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12)) +
  theme_minimal()
```
 

#### -- Sex interaction
Plot change in performance across trials by sex
```{r}
ADerroTypeFHsex <- emmip(lmer.SQRTADerror_FH.controls.Interaction3way, Type ~ FH  | genderLabs , CIs = TRUE, plotit=FALSE)
ADerroTypeFHsex
ADerroTypeFHsex.male <- ADerroTypeFHsex %>% filter(genderLabs == "Male")
ADerroTypeFHsex.female <- ADerroTypeFHsex%>% filter(genderLabs == "Female")
ADerroTypeFHsex.male$yvar.c <- ADerroTypeFHsex.male$yvar - mean(ADerroTypeFHsex.male$yvar)
ADerroTypeFHsex.female$yvar.c <- ADerroTypeFHsex.female$yvar - mean(ADerroTypeFHsex.female$yvar)
```
 Male
```{r}
p <- ggplot(ADerroTypeFHsex.male, aes(x=Type,y=yvar.c,fill=FH,color=FH)) +
  geom_bar(stat="identity",position="dodge") +
  geom_errorbar(position=position_dodge(.9), width=.25,
                aes(ymax=yvar.c+SE,ymin=yvar.c-SE), 
                alpha=0.8)+ # add standard error bars according to mean centred predicted values
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  #geom_signif(y_position = c(0.23,0.28),
   #          xmin=c(2+0.25,1+0.23),
    #         xmax=c(3+0.25,3+0.25),
     #        annotation = c("p=0.029","p<0.001"), tip_length = 0, alpha=0.8) +
  scale_color_manual(values=c("#0073C2","#EFC000")) +
  scale_fill_manual(values=c("#0073C286","#EFC00086"))
ggpar(p, 
      xlab = "Return condition type",
      ylab = "Relative change in location error (m)",
      legend.title = "Family history status") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12)) +
  theme_minimal()
```
 Female
```{r}
p <- ggplot(ADerroTypeFHsex.female, aes(x=Type,y=yvar.c,fill=FH)) +
  geom_bar(stat="identity",position="dodge") +
  geom_errorbar(position=position_dodge(.9), width=.25,
                aes(ymax=yvar.c+SE,ymin=yvar.c-SE), 
                alpha=0.3)+ # add standard error bars according to mean centred predicted values
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
  scale_y_continuous(limits = c(-0.15, 0.3))

ggpar(p, palette = "jco",
      xlab = "Return condition type",
      ylab = "Relative change in location error (m)",
      legend.title = "Family history status") +
  theme(strip.background = element_rect(colour="black",fill="#F5F5F5"), strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```

 plot FH by trial  and sex (white out labels for females)
```{r}
annotation_df <- data.frame(
  sex = c("Male","Female",NA),
  start=c(0.9,1.9,2.9),
  end=c(1.1,2.1,3.1),
  labels = c("ns","ns","p=0.085"), 
  y = c(1.6,1.6,1.6)
)

p <- ggline(PITall.PREVENTmeta.noOoB.full,x="Type",y="ADerror",
       color="FH", palette = "jco", add='mean_se',
       facet.by = "genderLabs",
       #title = "Family history group differences on location error per trial type",
       xlab = "Return condtion type", ylab = "Location error (m)") +
  scale_x_discrete(labels = c("No change","No optic flow", "No distal cues")) +
    geom_signif(y_position = c(1.75,1.75,1.75),
              xmin=c(0.9,1.9,2.9),
              xmax=c(1.1,2.1,3.1),
              annotation = c("ns","ns","p=0.016"), tip_length = 0.001,alpha=0.8,vjust=-0.1)
ggpar(p,ylim=c(0.9,1.8))
```

#### -- EYOD
For FH males only, given select behavioural findings on no distal cues condition
```{r}
lm.type3EYOD <- lm(data=filter(PITtype3mean.PREVENTmeta2, FH==1), meanADerror ~ EYOD + genderLabs + encrypt_age + nbeduc)
summary(lm.type3EYOD)
anova(lm.type3EYOD)

# location error
cor.test(PITtype3mean.PREVENTmeta.male$EYOD,PITtype3mean.PREVENTmeta.male$meanADerror)
cor.test(PITtype3mean.PREVENTmeta.male$encrypt_age,PITtype3mean.PREVENTmeta.male$meanADerror)
# angular error
cor.test(PITtype3mean.PREVENTmeta.male$EYOD,PITtype3mean.PREVENTmeta.male$meanAAerror)
cor.test(PITtype3mean.PREVENTmeta.male$encrypt_age,PITtype3mean.PREVENTmeta.male$meanAAerror)
# distance error
cor.test(PITtype3mean.PREVENTmeta.male$EYOD,PITtype3mean.PREVENTmeta.male$meanDdifferrorAbs)
cor.test(PITtype3mean.PREVENTmeta.male$encrypt_age,PITtype3mean.PREVENTmeta.male$meanDdifferrorAbs)
```

## PIT change in performance across trials
Linear regression
- for location error change, use meanADerror
- for angular error change, use meanAAerror
- for distance error change, use meanDdifferrorAbs
```{r}
# BASELINE > NO DISTAL CUES
lm.change.FHgender <- lm(data=PITchange.PREVENTmeta, meanADerror ~ FH*genderLabs + encrypt_age + nbeduc)
anova(lm.change.FHgender)
summary(lm.change.FHgender)
emmeans(lm.change.FHgender, specs = pairwise ~ FH * genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)

fisher.test(PITchange.PREVENTmeta$change,PITchange.PREVENTmeta$FH)

## angular error
lm.changeAA.FHgender <- lm(data=PITchange.PREVENTmeta, meanAAerror ~ FH*genderLabs + encrypt_age + nbeduc)
anova(lm.changeAA.FHgender)
summary(lm.changeAA.FHgender)
emmeans(lm.changeAA.FHgender, specs = pairwise ~ FH * genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)

## distance error
lm.changeD.FHgender <- lm(data=PITchange.PREVENTmeta, meanDdifferrorAbs ~ FH*genderLabs + encrypt_age + nbeduc)
anova(lm.changeD.FHgender)
summary(lm.changeD.FHgender)
emmeans(lm.changeD.FHgender, specs = pairwise ~ FH * genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)

# BASELINE > NO OPTIC FLOW
lm.change2.FHgender <- lm(data=PITchange2.PREVENTmeta, meanADerror ~ FH*genderLabs + encrypt_age + nbeduc)
anova(lm.change2.FHgender)
summary(lm.change2.FHgender)
emmeans(lm.change.FHgender, specs = pairwise ~ FH | genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)

## angular error
lm.change2AA.FHgender <- lm(data=PITchange2.PREVENTmeta, meanAAerror ~ FH*genderLabs + encrypt_age + nbeduc)
anova(lm.change2AA.FHgender)
summary(lm.change2AA.FHgender)
emmeans(lm.change2AA.FHgender, specs = pairwise ~ FH | genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)

## distance error
lm.change2D.FHgender <- lm(data=PITchange2.PREVENTmeta, meanDdifferrorAbs ~ FH*genderLabs + encrypt_age + nbeduc)
anova(lm.change2D.FHgender)
summary(lm.change2D.FHgender)
emmeans(lm.change2D.FHgender, specs = pairwise ~ FH | genderLabs, adjust = "tukey",type="response",pbkrtest.limit = 3564)
```

## Allocentric
```{r}
lm.4MT.FH <- lm(data=PREVENTmeta.full, 
                mount_task_total ~ FH*genderLabs + encrypt_age + nbeduc + date_vi)
lm.4MT.FH <- lm(data=PITchange.PREVENTmeta, 
                mount_task_total ~ `Multi-hereditary risk` + genderLabs + encrypt_age + nbeduc + date_vi)
plot(lm.4MT.FH)
anova(lm.4MT.FH)
summary(lm.4MT.FH)
emmeans(lm.4MT.FH, pairwise ~ FH, adjust="tukey")
emmeans(lm.4MT.FH, pairwise ~ FH:genderLabs, adjust="tukey")
emmeans(lm.4MT.FH, pairwise ~ `Multi-hereditary risk`, adjust="tukey")
```
## Egocentric
```{r}
lm.VRSTT.FH <- lm(data=PREVENTmeta.full, 
                supm_task_total ~ FH * genderLabs + encrypt_age + nbeduc + date_vi)
lm.VRSTT.FH <- lm(data=PITchange.PREVENTmeta, 
                supm_task_total ~ `Multi-hereditary risk`+genderLabs + encrypt_age + nbeduc + date_vi)
plot(lm.VRSTT.FH)
anova(lm.VRSTT.FH)
summary(lm.VRSTT.FH)
emmeans(lm.VRSTT.FH, pairwise ~ FH, adjust="tukey")
emmeans(lm.VRSTT.FH, pairwise ~ FH*genderLabs, adjust="tukey")
emmeans(lm.VRSTT.FH, pairwise ~ `Multi-hereditary risk`, adjust="tukey") # just effect of FH for women
```
## Episodic memory
narrative recall
```{r}
lm.NarRec.FH <- lm(data=PREVENTmeta.full, 
                EP21T ~ FH*genderLabs + encrypt_age + nbeduc)
lm.NarRec.FH <- lm(data=PITchange.PREVENTmeta, 
                EP21T ~ `Multi-hereditary risk` + genderLabs + encrypt_age + nbeduc)
plot(lm.NarRec.FH)
anova(lm.NarRec.FH)
emmeans(lm.NarRec.FH, pairwise ~ `Multi-hereditary risk`, adjust="tukey")
emmeans(lm.NarRec.FH, pairwise ~ FH:genderLabs, adjust="tukey")
```

name-face association
```{r}
lm.NarRec.FH <- lm(data=PREVENTmeta.full, 
                EP18BN ~ FH*genderLabs + encrypt_age + nbeduc)
lm.NarRec.FH <- lm(data=PITchange.PREVENTmeta, 
                EP18BN ~ `Multi-hereditary risk` + genderLabs + encrypt_age + nbeduc)
plot(lm.NarRec.FH)
anova(lm.NarRec.FH)
emmeans(lm.NarRec.FH, pairwise ~ `Multi-hereditary risk`, adjust="tukey")
emmeans(lm.NarRec.FH, pairwise ~ FH, adjust="tukey")
emmeans(lm.NarRec.FH, pairwise ~ FH:genderLabs, adjust="tukey")
```

## Visual short term binding
```{r}
lm.VSTBT.FH <- lm(data=PREVENTmeta.full, 
                SHPCOLBINDING_PCR ~ FH*genderLabs + encrypt_age + nbeduc + date_vi)
lm.VSTBT.FH <- lm(data=PITchange.PREVENTmeta, 
                SHPCOLBINDING_PCR ~ `Multi-hereditary risk` + genderLabs + encrypt_age + nbeduc)
plot(lm.VSTBT.FH)
anova(lm.VSTBT.FH)
emmeans(lm.VSTBT.FH, pairwise ~ FH, adjust="tukey")
emmeans(lm.VSTBT.FH, pairwise ~ FH:genderLabs, adjust="tukey")
emmeans(lm.VSTBT.FH, pairwise ~ `Multi-hereditary risk`, adjust="tukey")
```

# 2. CAIDE
Did not end up using sex interactions because sex is encoded in score
## PIT
Linear mixed model for all conditions/trials
- for location error, use ADerror
- for angular error, use AAerror
- for distance error, use DdifferrorAbs
```{r}
lmer.ADerrorSQRT_CAIDEnoAP.controlsC <- lmer(data=PITall.PREVENTmeta.clean.noOoB, sqrt(ADerror) ~ Type*DRS_noAP*genderLabs + DistIncom + AngleIncomAbs + (Type | Code) + (1 | TrialNo), REML=FALSE,control = lmerControl(optimizer ="Nelder_Mead"))

anova(lmer.ADerrorSQRT_CAIDEnoAP.controlsC)
summary(lmer.ADerrorSQRT_CAIDEnoAP.controlsC)

emtrends(lmer.ADerrorSQRT_CAIDEnoAP.controlsC,pairwise~Type,var="DRS_noAP",type="response",adjust="tukey") # KEEP
emtrends(lmer.ADerrorSQRT_CAIDEnoAP.controlsC,pairwise~Type|genderLabs,var="DRS_noAP",type="response",adjust="tukey")

mylist <- list(DRS_noAP = c(3,5,7,9,11,13,15,17),Type=c("1","2","3"),genderLabs = c("Male","Female"),AngleIncomAbs = c(60,100,140,180), DistIncom = c(3.6,3.7,3.8,3.9,4.0))
```

```{r}
emmip(lmer.ADerrorSQRT_CAIDEnoAP.controlsC,Type~DRS_noAP,at=mylist,CIs=TRUE)
DRSnoAPtypegender <- emmip(lmer.ADerrorSQRT_CAIDEnoAP.controlsC,Type~DRS_noAP,at=mylist,CIs=TRUE,plotit = FALSE)
levels(DRSnoAPtypegender$Type)[levels(DRSnoAPtypegender$Type)=="1"] <- "No change"
levels(DRSnoAPtypegender$Type)[levels(DRSnoAPtypegender$Type)=="2"] <- "No optic flow cues"
levels(DRSnoAPtypegender$Type)[levels(DRSnoAPtypegender$Type)=="3"] <- "No distal cues"
```

```{r}
scaleFUN <- function(x) sprintf("%.1f", x)
p <- ggplot(data=DRSnoAPtypegender,aes(x=DRS_noAP,y=yvar,color=Type)) + 
  geom_line(linetype=1,size=1) +
  geom_ribbon(aes(ymax=UCL,ymin=LCL,color=Type,fill=Type),alpha=0.4,size=0.01)
ggpar(p, palette = "jco",xlab = "CAIDE DRS",
      ylab = "Location Error (m)",
      legend.title = "Return condition") +
  rremove("grid") +
  bgcolor("#FFFFFF") +
  border("#000000") +
  scale_y_continuous(labels=scaleFUN) +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```

## PIT change in performance across trials
Linear regression
- for location error change, use meanADerror
- for angular error change, use meanAAerror
- for distance error change, use meanDdifferrorAbs
```{r}
# BASELINE > NO DISTAL CUES
lm.changeAD.DRS <- lm(data=PITchange.PREVENTmeta, meanADerror ~ DRS_noAP*genderLabs + encrypt_age + nbeduc)
anova(lm.changeAD.DRS)
summary(lm.changeAD.DRS)

cor.test(PITchange.PREVENTmeta$DRS_noAP,  PITchange.PREVENTmeta$meanADerror, method = "spearman")
cor.test(PITchange.PREVENTmeta$DRS_noAP,  PITchange.PREVENTmeta$meanADerror)
hist(PITchange.PREVENTmeta$DRS_noAP)

# angular error
lm.changeAA.DRS <- lm(data=PITchange.PREVENTmeta, meanAAerror ~ DRS_noAP*genderLabs + encrypt_age + nbeduc)
lm.changeAA.DRS <- lm(data=PITchange.PREVENTmeta, meanAAerror ~ DRS_noAP)
anova(lm.changeAA.DRS)
summary(lm.changeAA.DRS)

cor.test(PITchange.PREVENTmeta$DRS_noAP, PITchange.PREVENTmeta$meanAAerror, method = "spearman")
cor.test(PITchange.PREVENTmeta$DRS_noAP, PITchange.PREVENTmeta$meanDdifferrorAbs, method = "spearman")

# BASELINE > NO OPTIC FLOW 
# correlation first to explore relationship
# location error
cor.test(PITchange2.PREVENTmeta$DRS_noAP, PITchange2.PREVENTmeta$meanADerror, method = "spearman")
# angular error
cor.test(PITchange2.PREVENTmeta$DRS_noAP, PITchange2.PREVENTmeta$meanAAerror, method = "spearman")
# distance error
cor.test(PITchange2.PREVENTmeta$DRS_noAP, PITchange2.PREVENTmeta$meanDdifferrorAbs, method = "spearman")
```



```{r}
ggscatter(PITchange.PREVENTmeta, x="DRS_noAP",y="meanADerror",
          add = "reg.line",conf.int = TRUE,color="#3B3B3B",
          title = "CAIDE association with change in location error",
          xlab = "CAIDE DRS", ylab = "Change in location error (m)",ggtheme=theme_minimal()) +
  stat_cor(method="spearman") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```


## Allocentric
```{r}
lm.4MT.caide <- lm(data=PREVENTmeta.full, 
                mount_task_total ~ DRS_noAP + genderLabs + encrypt_age + nbeduc)
lm.4MT.caideNOCONTROL <- lm(data=PREVENTmeta.full, 
                mount_task_total ~ DRS_noAP)
plot(lm.4MT.caide)
anova(lm.4MT.caide)
summary(lm.4MT.caide)
summary(lm.4MT.caideNOCONTROL)
test(emtrends(lm.4MT.caide, ~ genderLabs,var="DRS_noAP", adjust="tukey"))
emtrends(lm.4MT.caide, pairwise~ genderLabs,var="DRS_noAP")
```

## Egocentric
```{r}
lm.VRSTT.caide <- lm(data=PREVENTmeta.full, 
                log(supm_task_total) ~ DRS_noAP*genderLabs)
plot(lm.VRSTT.caide)
anova(lm.VRSTT.caide)
summary(lm.VRSTT.caide)
test(emtrends(lm.VRSTT.caide, ~ genderLabs,var="DRS_noAP", adjust="tukey",type="response"))
```

## Episodic
```{r}
# narrartive recall
lm.NarRec.DRSap <- lm(data=PREVENTmeta.full, 
                EP21T ~ DRS_noAP)
plot(lm.NarRec.DRSap)
anova(lm.NarRec.DRSap)
summary(lm.NarRec.DRSap)

# name-face
lm.NarRec.DRS <- lm(data=PREVENTmeta.full, 
                EP18BN ~ DRS_noAP)
plot(lm.NarRec.DRS)
anova(lm.NarRec.DRS)
summary(lm.NarRec.DRS)
```
## Visual short term binding
```{r}
lm.VSTBT.caide <- lm(data=PREVENTmeta.full, 
                SHPCOLBINDING_PCR ~ DRS_noAP*genderLabs)
plot(lm.4MT.caide)
anova(lm.VSTBT.caide)
summary(lm.VSTBT.caide)
test(emtrends(lm.VSTBT.caide, ~ genderLabs, var="DRS_noAP", adjust="tukey"))
```


# 3. Multifactor risk
Two variables explored: 'Multi-hereditary risk' (four way stratification of FH and APOE status) or 'Risk' (two-way stratification, FH+/APOE+ vs everyone else) - the latter was used for binary ROC and smaller group size neuroimaging analysis

## PIT change in performance, baseline > no distal cues
- for location error change, use meanADerror
- for angular error change, use meanAAerror
- for distance error change, use meanDdifferrorAbs
```{r}
# four way
lm.change.multi <- lm(data=PITchange.PREVENTmeta, meanADerror ~ `Multi-hereditary risk`* genderLabs + encrypt_age + nbeduc)

anova(lm.change.multi)
summary(lm.change.multi)
emmeans(lm.change.multi, specs = pairwise ~ `Multi-hereditary risk`*genderLabs , adjust = "tukey",type="response",pbkrtest.limit = 3564)
emmeans(lm.change.multi, specs = pairwise ~ `Multi-hereditary risk`, adjust = "tukey",type="response",pbkrtest.limit = 3564)

# four way x CAIDE
lm.change.multi <- lm(data=PITchange.PREVENTmeta, meanADerror ~ `Multi-hereditary risk`*DRS_noAP + genderLabs + encrypt_age + nbeduc)

anova(lm.change.multi)
summary(lm.change.multi)
emmeans(lm.change.multi, specs = pairwise ~ `Multi-hereditary risk`*genderLabs , adjust = "tukey",type="response",pbkrtest.limit = 3564)

# two way
lm.change.multi <- lm(data=PITchange.PREVENTmeta, meanADerror ~ Risk * genderLabs + encrypt_age + nbeduc)

anova(lm.change.multi)
summary(lm.change.multi)
emmeans(lm.change.multi, specs = pairwise ~ Risk*genderLabs , adjust = "tukey",type="response",pbkrtest.limit = 3564)

# two-way * CAIDE
lm.change.multi <- lm(data=PITchange.PREVENTmeta, meanADerror ~ Risk * DRS_noAP + genderLabs + encrypt_age + nbeduc)

anova(lm.change.multi)
summary(lm.change.multi)
emmeans(lm.change.multi, specs = pairwise ~ Risk*genderLabs , adjust = "tukey",type="response",pbkrtest.limit = 3564)
```


```{r}
ggbarplot(filter(PITchange.PREVENTmeta, !is.na(apoe4)), x="Multi-hereditary risk",y="meanADerror",color="Multi-hereditary risk",fill="Multi-hereditary risk",add=c("mean_se","jitter"),ylab = "Change in location error (m)",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC","#003C67","#EFC000")) +
  scale_fill_manual(values=c("#003C6766","#4A699066","#7AA6DC66","#EFC00066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```

```{r}
ggbarplot(filter(PITchange.PREVENTmeta, !is.na(apoe4)), x="Risk",y="meanADerror",
          color="Risk",fill="Risk",
          add=c("mean_se","jitter"),ylab = "Change in location error (m)",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC")) +
  scale_fill_manual(values=c("#003C6766","#4A699066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```

```{r}
ggbarplot(filter(PITchange.PREVENTmeta, !is.na(apoe4)), x="Risk",y="meanADerror",
          color="Risk",fill="Risk",facet.by = "genderLabs",
          add=c("mean_se","jitter"),ylab = "Change in location error (m)",ggtheme=theme_minimal()) +
  scale_color_manual(values=c("#4A6990","#7AA6DC")) +
  scale_fill_manual(values=c("#003C6766","#4A699066")) +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))
```

## Other assessments
As above for FH/APOE factors, but swapping in four-way risk variable instead of FH/APOE

# - - MRI STRUCTURE - -

## Risk factors
A series of linear regression models exploring each ROI as a response and each risk factor as a predictor e.g. swapping FH for APOE or CAIDE or two-way multifactor risk
```{r}
modelsList <- list(lm.pmEC.FH = lm(data=MRIsubsample,pmEC_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.alEC.FH = lm(data=MRIsubsample,alEC_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.CA1.FH = lm(data=MRIsubsample,CA1_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.CA2.FH = lm(data=MRIsubsample,CA2_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.CA3.FH = lm(data=MRIsubsample,CA3_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.DG.FH = lm(data=MRIsubsample,DG_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.Tail.FH = lm(data=MRIsubsample,Tail_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.PrC.FH = lm(data=MRIsubsample,PrC_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.Sub.FH = lm(data=MRIsubsample,Sub_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.PhC.FH = lm(data=MRIsubsample,PhC_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.RSC.FH = lm(data=MRIsubsample,isthm_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.PCC.FH = lm(data=MRIsubsample,post_volume_cor ~ FH + genderLabs + encrypt_age + nbeduc),
               lm.Total.FH = lm(data=MRIsubsample,BrainSegVolNotVent ~ FH + genderLabs + encrypt_age + nbeduc))
modelsAnova <- lapply(modelsList,anova)
lapply(modelsList,summary)
# cumbersome manual extraction of p value for risk factor into vector, I know it is terrible
pvec.FH = c(0.35,0.14,0.84,0.68,0.72,0.38,0.57,0.78,0.11,0.88,0.32)
pvec.FH.correct <- p.adjust(pvec.FH,"BH")
pvec.FH.correct
```

## PIT change in location error * risk factors

```{r}
modelsListPIT <- list(lm.pmEC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ pmEC_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.alEC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ alEC_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.EC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ EC_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.CA1.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ CA1_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.Sub.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ Sub_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.RSC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ isthm_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.PCC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ post_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.PrC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ PrC_volume_cor*FH*genderLabs + encrypt_age + nbeduc),
               lm.PhC.FH = lm(data=PITchange.PREVENTmeta.MRI,meanAAerror ~ PhC_volume_cor*FH*genderLabs + encrypt_age + nbeduc))

modelsSummary <- lapply(modelsListPIT,summary)
modelsAnova<- lapply(modelsListPIT,anova)

# same as above - manually extract p values and correct
```


# - - fMRI GRID ACTIVITY - -

## Grid cell metrics
```{r}
# magnitude
t.test(MRIsubsample$GCmagnitude_allRuns_pmECDTI_right_6, mu = 0)
# temporal stability
t.test(MRIsubsample$tStability_pmECDTI_right_6_av, mu = 50)
# spatial stability
t.test(MRIsubsample$sStability_pmECDTI_right_6_av, mu = 0)

# risk factors -FH/APOE
t.test(GCmagnitude_allRuns_pmECDTI_right_6~FH, data=MRIsubsample)

# risk factors CAIDE
ggscatter(MRIsubsample, y="GCmagnitude_allRuns_pmECDTI_right_6",x="DRS_noAP",add="reg.line",conf.int = TRUE,palette = "jco",
            ylab = "Magnitude of grid-cell-like representations",xlab="CAIDE DRS") +
  stat_cor(method="pearson")

# volume control
ggscatter(MRIsubsample, x="rh_pmECDTI_volume", y="GCmagnitude_allRuns_pmEC_right_6",
          add="reg.line",conf.int=TRUE,
          xlab="pmEC volume",ylab="pmEC GLR magnitude") +
  stat_cor(method="pearson")

# tSNR control
ggscatter(MRIsubsample, x="tSNR_pmECDTI_right_6", y="GCmagnitude_allRuns_pmECDTI_right_6",
          add="reg.line",conf.int=TRUE, xlab="tSNR", ylab="Magnitude of grid cell like representations") +
  stat_cor(method="pearson")

```

## PIT * grid cell metrics

```{r}
lm.GCchange <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6 + 
                       nbeduc + encrypt_age + genderLabs)
summary(lm.GCchange)
```

```{r}
ggscatter(PITchange.PREVENTmeta.MRI, x="GCmagnitude_allRuns_pmECDTI_right_6",y="meanADerror",
          add = "reg.line",conf.int = TRUE,palette="jco",
          title = "6-fold Model",
          xlab = "Magnitude of grid cell like representations", ylab = "Change in location error (m)") +
  stat_cor(method="spearman")
```

## Risk * PIT * grid cell metrics

Again exchange below FH factor for apoe4 or Risk (multifactor two-way)

#### Linear regression

```{r}
lm.GCchange.FH <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6*FH*genderLabs + nbeduc + encrypt_age)
summary(lm.GCchange.FH)
anova(lm.GCchange.FH)

emtrends(lm.GCchange.FH,pairwise ~FH*genderLabs,var="GCmagnitude_allRuns_pmECDTI_right_6", type="response",adjust="tukey" )
# male and female FH+ significantly different
```

```{r}
ggscatter(PITchange.PREVENTmeta.MRI, x="GCmagnitude_allRuns_pmECDTI_right_6",y="meanADerror",
          add = "reg.line",conf.int = TRUE,palette="jco",color="FH",facet.by = "genderLabs",
          title = "Association of pmEC Grid signal with change in location error",
          xlab = "Magnitude of grid cell like representations", ylab = "Change in location error (m)") +
  stat_cor(aes(color=FH),method="pearson",label.y= c(1.6,1.8))
```

##### CAIDE interactions code

```{r}
lm_ADerror<-lm(data=PITchange.PREVENTmeta.MRI, meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_6 * DRS_noAP)
summary(lm_ADerror)
anova(lm_ADerror)

interact_plot(lm_ADerror, pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP, interval = TRUE,
              x.label = "fMRI grid cell activity magnitude",
              y.label = "Change in location error (m)",
              legend.main = "CAIDE") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
      legend.title = element_text(size=12),
      legend.text = element_text(size=12))

object <- johnson_neyman(model = lm_ADerror,pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP) 
object$plot + xlab("CAIDE") + ylab("Beta regression value") +
theme(strip.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
      legend.title = element_text(size=12),
      legend.text = element_text(size=12))

sim_slopes(lm_ADerror, pred = GCmagnitude_allRuns_pmECDTI_right_6 , modx = DRS_noAP, jnplot = TRUE) 
```


#### Model comparison

```{r}
lm.changeFH <- lm(data=filter(PITchange.PREVENTmeta.MRI,!is.na(GCmagnitude_allRuns_pmECDTI_right_6)), meanADerror ~ FH * genderLabs + encrypt_age + nbeduc) #null model, no fMRI
lm.GCchange.FH <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_6*FH*genderLabs + nbeduc + encrypt_age) # model of interest with fMRI

anova(lm.changeFH, lm.GCchange.FH)
```

#### Control models
Comparing 5fold and 7fold grid cell activity to show the 6fold has the greatest effect, in line with principles of grid cell function
```{r}
lm.GCchange5.FH <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_5*FH*genderLabs + nbeduc + encrypt_age)
summary(lm.GCchange5.FH)
anova(lm.GCchange5.FH)

lm.GCchange7.FH <- lm(data=PITchange.PREVENTmeta.MRI,meanADerror~GCmagnitude_allRuns_pmECDTI_right_7*Risk*genderLabs + nbeduc + encrypt_age)
summary(lm.GCchange7.FH)
anova(lm.GCchange7.FH)

lm_ADerror<-lm(data=PITchange.PREVENTmeta.MRI, meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_5 * DRS_noAP)
summary(lm_ADerror)
anova(lm_ADerror)

lm_ADerror<-lm(data=PITchange.PREVENTmeta.MRI, meanADerror ~ GCmagnitude_allRuns_pmECDTI_right_7 * DRS_noAP)
summary(lm_ADerror)
anova(lm_ADerror)

```

```{r}
ggscatter(filter(PITchange.PREVENTmeta.MRI,!is.na(CAIDELabs_noAPOE)), x="GCmagnitude_allRuns_pmECDTI_right_7",y="meanADerror",
          add = "reg.line",conf.int = TRUE,palette="jco",facet.by = "CAIDELabs_noAPOE",
          title = "Association of pmEC Grid signal with change in angular error",
          xlab = "GLRs magnitude", ylab = "Change in angular error (deg)") +
  stat_cor(method="pearson")
```

